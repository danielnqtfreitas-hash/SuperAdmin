<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin | Marketplace Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .table-container { overflow-x: auto; scrollbar-width: thin; -webkit-overflow-scrolling: touch; }
        .modal-blur { backdrop-filter: blur(12px); background: rgba(2, 6, 23, 0.85); }
        .input-premium {
            width: 100%;
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 1rem;
            padding: 0.85rem 1.25rem;
            color: white;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-premium:focus { border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15); background-color: #0f172a; }
        .btn-hover { transition: all 0.2s ease; }
        .btn-hover:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .animate-pop-in { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        #login-screen { background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.2), transparent), #020617; }
        
        /* Sorting UI */
        .sort-btn { @apply px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all border border-slate-800; }
        .sort-btn.active { @apply bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-600/20; }
        .sort-btn:not(.active) { @apply bg-slate-900 text-slate-500 hover:text-slate-300 hover:bg-slate-800; }

        .group-header { background: linear-gradient(90deg, #1e293b 0%, transparent 100%); }
        .chevron-rotate { transition: transform 0.3s ease; }
        .chevron-active { transform: rotate(90deg); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 h-screen flex overflow-hidden w-full">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[200] flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-800 p-10 rounded-[3rem] max-w-md w-full shadow-2xl animate-pop-in">
            <div class="flex flex-col items-center text-center mb-10">
                <div class="bg-indigo-600 p-5 rounded-[2rem] shadow-xl mb-5"><i data-lucide="shield-check" class="w-12 h-12 text-white"></i></div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Super Admin</h1>
                <p class="text-slate-400 text-sm mt-2">√Årea Restrita - Acesso √önico</p>
            </div>
            <form id="loginForm" class="space-y-5">
                <input type="email" id="loginEmail" required class="input-premium" placeholder="admin@sistema.com">
                <input type="password" id="loginPassword" required class="input-premium" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <div id="loginError" class="hidden p-4 bg-red-500/10 border border-red-500/30 rounded-2xl text-red-500 text-xs text-center font-bold">Acesso negado.</div>
                <button type="submit" id="btnLogin" class="w-full py-4.5 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-2xl shadow-lg transition-all btn-hover h-14 text-sm uppercase tracking-widest">Aceder ao Painel</button>
            </form>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 border-r border-slate-800 z-50 transform -translate-x-full md:translate-x-0 md:relative flex flex-col transition-transform duration-300">
        <div class="h-20 flex items-center justify-between px-6 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-xl"><i data-lucide="shield" class="w-5 h-5 text-white"></i></div>
                <span class="font-bold text-lg">Super Admin</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchView('list')" id="nav-list" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-sm font-medium transition-all bg-indigo-600/10 text-indigo-400 border border-indigo-600/50"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard</button>
            <button onclick="switchView('requests')" id="nav-requests" class="w-full flex items-center justify-between px-4 py-3.5 rounded-2xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all">
                <div class="flex items-center gap-3"><i data-lucide="user-plus" class="w-5 h-5"></i> Solicita√ß√µes</div>
                <span id="reqCountBadge" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded-full">0</span>
            </button>
            <button onclick="switchView('plans')" id="nav-plans" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all"><i data-lucide="package" class="w-5 h-5"></i> Planos</button>
            <button onclick="switchView('create')" id="nav-create" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all"><i data-lucide="plus-circle" class="w-5 h-5"></i> Novo Cadastro</button>
            <button onclick="switchView('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all"><i data-lucide="bell" class="w-5 h-5"></i> Notifica√ß√µes</button>
        </nav>
        <div class="p-6 border-t border-slate-800">
            <button onclick="handleSignOut()" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 hover:text-red-400 text-xs font-black uppercase tracking-widest"><i data-lucide="log-out" class="w-4 h-4"></i> Sair</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-950 w-full">
        <header class="h-20 flex items-center justify-between px-6 md:px-10 border-b border-slate-800 bg-slate-950/50 backdrop-blur-md z-40">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-300 bg-slate-900 rounded-xl"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <h2 id="viewTitle" class="text-xl font-bold text-white tracking-tight">Gest√£o de Lojas</h2>
            </div>
            <div class="hidden md:flex items-center gap-2 px-4 py-2 bg-indigo-600/10 border border-indigo-600/30 rounded-full">
                <span class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span>
                <span id="syncStatus" class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Sincronizado</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-6xl mx-auto pb-24">
                
                <!-- VIEW: LISTA -->
                <div id="view-list" class="animate-fade-in space-y-8">
                    
                    <div class="bg-slate-900/30 border border-slate-800/50 p-6 rounded-[2.5rem] space-y-6">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                            <div>
                                <h3 class="text-xl font-bold text-white">Filtros Inteligentes</h3>
                                <p class="text-[10px] text-slate-500 uppercase tracking-widest font-black mt-1">Navega√ß√£o avan√ßada de dados</p>
                            </div>
                            <div class="flex items-center gap-3 bg-slate-950/50 p-1.5 rounded-2xl border border-slate-800">
                                <button onclick="toggleGrouping()" id="btnGroup" class="flex items-center gap-2 px-4 py-2 text-[10px] font-bold uppercase tracking-tighter text-slate-400 hover:text-white transition-all">
                                    <i data-lucide="layers" class="w-4 h-4"></i> Agrupar por Plano
                                </button>
                                <div class="w-px h-6 bg-slate-800"></div>
                                <div class="relative w-48 sm:w-64">
                                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-500"></i>
                                    <input type="text" id="searchInput" oninput="handleSearch(this.value)" placeholder="Pesquisar loja..." class="w-full bg-transparent text-xs text-white pl-9 pr-4 py-2 outline-none">
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2 pt-2">
                            <button onclick="setSort('name')" id="sort-name" class="sort-btn active">Nome</button>
                            <button onclick="setSort('date')" id="sort-date" class="sort-btn">Data Cria√ß√£o</button>
                            <button onclick="setSort('day')" id="sort-day" class="sort-btn">Vistas Hoje</button>
                            <button onclick="setSort('week')" id="sort-week" class="sort-btn">Semana</button>
                            <button onclick="setSort('month')" id="sort-month" class="sort-btn">M√™s</button>
                            <button onclick="setSort('total')" id="sort-total" class="sort-btn">Geral</button>
                        </div>
                    </div>

                    <div class="table-container bg-slate-900/50 rounded-[2.5rem] border border-slate-800 shadow-2xl">
                        <table class="w-full text-left text-sm min-w-[1000px]">
                            <thead class="bg-slate-900 text-slate-400 text-[10px] uppercase font-black tracking-widest">
                                <tr>
                                    <th class="px-4 py-6 w-12 text-center">#</th>
                                    <th class="px-8 py-6">Loja / Endere√ßo</th>
                                    <th class="px-8 py-6">Plano</th>
                                    <th class="px-8 py-6">Performance (M√™s)</th>
                                    <th class="px-8 py-6">Status</th>
                                    <th class="px-8 py-6 text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="storesTableBody" class="divide-y divide-slate-800/50">
                                <tr><td colspan="6" class="p-16 text-center text-slate-500 italic">Inicializando banco de dados...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: REQUESTS -->
                <div id="view-requests" class="hidden animate-fade-in">
                    <div class="mb-10"><h2 class="text-2xl font-bold text-white">Solicita√ß√µes de Ades√£o</h2><p class="text-sm text-slate-500">Leads vindos do formul√°rio de pr√©-cadastro</p></div>
                    <div id="requestsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="emptyRequests" class="hidden text-center py-20 bg-slate-900 rounded-[3rem] border border-slate-800">
                        <i data-lucide="inbox" class="w-12 h-12 text-slate-700 mx-auto mb-4"></i>
                        <p class="text-slate-500">Nenhuma solicita√ß√£o pendente.</p>
                    </div>
                </div>

                <!-- VIEW: PLANS -->
                <div id="view-plans" class="hidden animate-fade-in">
                    <div class="flex justify-between items-center mb-10">
                        <div><h2 class="text-2xl font-bold text-white">Cat√°logo de Planos</h2><p class="text-sm text-slate-500">Configure as ofertas para o mercado</p></div>
                        <div class="flex gap-3">
                            <button onclick="publishPlansForRegistration()" class="bg-slate-800 text-white px-6 py-3 rounded-2xl text-xs font-bold border border-slate-700 transition-all hover:bg-slate-700">Publicar para Cadastro</button>
                            <button onclick="openPlanModal()" class="bg-pink-600 text-white px-6 py-3 rounded-2xl text-xs font-bold shadow-lg shadow-pink-600/20 btn-hover">Novo Plano</button>
                        </div>
                    </div>
                    <div id="plansGrid" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
                </div>

                <!-- VIEW: CREATE (Painel de Ativa√ß√£o) -->
                <form id="createStoreForm" class="bg-slate-900 border border-slate-800 p-10 rounded-[3.5rem] space-y-8 shadow-2xl">
    <input type="hidden" id="requestId">
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="md:col-span-2 space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Plano de Assinatura</label>
            <select id="storePlan" required class="input-premium bg-slate-800"></select>
        </div>

        <div class="space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Data de Vencimento</label>
            <input type="date" id="createExpiryDate" class="input-premium">
        </div>

        <div class="space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Tipo de Acesso</label>
            <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-xl border border-slate-700 cursor-pointer h-[52px]">
                <span class="text-[10px] font-bold text-slate-300">Marcar como Parceiro Beta?</span>
                <input type="checkbox" id="createIsBeta" class="w-4 h-4 accent-indigo-500">
            </label>
        </div>

        <div class="space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Nome da Loja</label>
            <input type="text" id="storeName" required class="input-premium">
        </div>
        
        <div class="space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Slug URL (Pasta)</label>
            <input type="text" id="storeSlug" required class="input-premium font-mono">
        </div>

        <div class="space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Email do Lojista</label>
            <input type="email" id="adminEmail" required class="input-premium">
        </div>

        <div class="space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">WhatsApp</label>
            <input type="text" id="storePhone" required class="input-premium">
        </div>

        <div class="md:col-span-2 space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Senha de Acesso</label>
            <input type="text" id="adminPass" required class="input-premium font-mono">
        </div>
    </div>
    
    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-5 rounded-3xl shadow-xl transition-all btn-hover uppercase tracking-widest text-xs">
        Confirmar e Gerar Acesso
    </button>
</form>


                <!-- VIEW: RESULT -->
                <div id="view-result-view" class="hidden animate-fade-in max-w-md mx-auto text-center space-y-8">
                    <div class="bg-indigo-900/20 border border-indigo-500/30 rounded-[3.5rem] p-10 shadow-2xl">
                        <div class="w-20 h-20 bg-green-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg"><i data-lucide="check" class="text-white w-10 h-10"></i></div>
                        <h3 class="text-2xl font-bold text-white mb-2">Vitrine Ativada!</h3>
                        <div class="bg-slate-950 p-6 rounded-3xl text-left text-xs font-mono space-y-3 mt-6 border border-slate-800">
                            <p class="flex justify-between"><span>LOGIN:</span> <span id="resEmail" class="text-green-400 font-bold"></span></p>
                            <p class="flex justify-between"><span>PASS:</span> <span id="resPass" class="text-indigo-400 font-bold"></span></p>
                        </div>
                        <button id="btnWhatsAppNotify" class="w-full bg-[#25D366] text-white font-bold py-5 rounded-3xl mt-8 flex justify-center items-center gap-3 shadow-lg btn-hover"><i data-lucide="message-circle" class="w-6 h-6"></i> Enviar credenciais via WhatsApp</button>
                    </div>
                </div>

                <!-- VIEW: SETTINGS -->
                <div id="view-settings" class="hidden animate-fade-in">
                    <h2 class="text-2xl font-bold text-white mb-10">Configura√ß√µes do Painel</h2>
                    <div class="bg-slate-900 border border-slate-800 p-8 rounded-[3rem] max-w-lg">
                        <button onclick="toggleAudioAlert()" id="btnToggleAudio" class="w-full py-4 px-6 rounded-2xl border flex items-center justify-center gap-3 font-bold text-xs uppercase transition-all"></button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- MODAIS -->

    <div id="plan-modal" class="fixed inset-0 z-[160] modal-blur hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-[3rem] max-w-xl w-full p-8 shadow-2xl animate-pop-in relative">
            <button onclick="closePlanModal()" class="absolute top-8 right-8 text-slate-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <h2 class="text-2xl font-bold text-white mb-8">Configurar Plano</h2>
            
            <form id="planForm" onsubmit="window.savePlan(event)" class="space-y-5">
                <input type="hidden" id="planId">
                <input type="text" id="planName" placeholder="Nome do Plano" required class="input-premium">
                
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="planPrice" placeholder="Pre√ßo (Ex: 99.90)" required class="input-premium">
                    <input type="number" id="planMaxProducts" placeholder="Limite Prod." required class="input-premium">
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <input type="number" id="planMaxBanners" placeholder="Quantidade de Banners" required class="input-premium">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 border-t border-slate-800 pt-4 mt-2">
                    <div class="col-span-full text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Recursos Liberados</div>
                    
                    <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-xl border border-slate-700 cursor-pointer">
                        <span class="text-[10px] font-bold text-slate-300">Aba Financeira</span>
                        <input type="checkbox" id="planHasFinance" class="w-4 h-4 accent-indigo-500">
                    </label>

                    <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-xl border border-slate-700 cursor-pointer">
                        <span class="text-[10px] font-bold text-slate-300">Setores M√°gicos</span>
                        <input type="checkbox" id="planHasMagic" class="w-4 h-4 accent-indigo-500">
                    </label>
                    
                    <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-xl border border-slate-700 cursor-pointer">
                        <span class="text-[10px] font-bold text-slate-300">Carrossel Banners</span>
                        <input type="checkbox" id="planHasCarousel" class="w-4 h-4 accent-indigo-500">
                    </label>
                </div>

                <textarea id="planFeatures" class="input-premium min-h-[80px]" placeholder="Benef√≠cios (Um por linha)"></textarea>
                
                <button type="submit" id="btnSavePlan" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg btn-hover uppercase tracking-widest text-xs">
                    Salvar Plano
                </button>
            </form>
        </div>
    </div>

<div id="edit-modal" class="fixed inset-0 z-[160] modal-blur hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-slate-700 rounded-[3rem] max-w-lg w-full p-10 shadow-2xl relative animate-pop-in">
        <button onclick="closeEditModal()" class="absolute top-8 right-8 text-slate-400 hover:text-white">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>
        
        <h2 class="text-2xl font-bold text-white mb-8">Editar Unidade</h2>
        
        <form id="editForm" onsubmit="window.saveStoreEdit(event)" class="space-y-5">
            <input type="hidden" id="editSlug">
            
            <div class="space-y-1.5">
                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Nome da Loja</label>
                <input type="text" id="editName" placeholder="Nome da Unidade" required class="input-premium">
            </div>

            <div class="space-y-1.5">
                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Plano (Aplica Benef√≠cios)</label>
                <select id="editPlan" required class="input-premium bg-slate-800"></select>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Data de Vencimento</label>
                    <input type="date" id="editExpiryDate" class="input-premium">
                </div>

                <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Status Beta</label>
                    <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-xl border border-slate-700 cursor-pointer h-[52px]">
                        <span class="text-[10px] font-bold text-slate-300">Parceiro Beta?</span>
                        <input type="checkbox" id="editIsBeta" class="w-4 h-4 accent-indigo-500">
                    </label>
                </div>
            </div>

            <div class="space-y-1.5">
                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">E-mail Administrativo</label>
                <input type="email" id="editEmail" placeholder="E-mail Administrativo" required class="input-premium">
            </div>

            <button type="submit" id="btnSaveEdit" class="w-full py-4.5 bg-indigo-600 text-white font-bold rounded-2xl btn-hover uppercase tracking-widest text-xs h-14">
                Guardar Altera√ß√µes
            </button>
        </form>
    </div>
</div>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, onSnapshot, serverTimestamp, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAdwsGBTApwOwqr37qCv72gdPRbipsZG0Q", authDomain: "meuestoque-1badc.firebaseapp.com", projectId: "meuestoque-1badc", storageBucket: "meuestoque-1badc.appspot.com", messagingSenderId: "730003067834", appId: "1:730003067834:web:b205f1ea59053345960383" };
        const mainApp = initializeApp(firebaseConfig);
        const auth = getAuth(mainApp);
        const db = getFirestore(mainApp);

        // --- GLOBAL STATE ---
        let availablePlans = [];
        let allStores = []; 
        let currentSort = 'name';
        let isGrouped = false;
        let config = { audioAlert: true, webhookUrl: '' };
        let lastRequestCount = -1;
        let analyticsCache = {}; // Cache anal√≠tico

        const formatBRL = (v) => Number(v).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

        // --- AUTH ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnLogin');
            btn.disabled = true; btn.innerHTML = 'Autenticando...';
            try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); } 
            catch (err) { document.getElementById('loginError').classList.remove('hidden'); btn.disabled = false; btn.innerHTML = 'Aceder'; }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const adminDoc = await getDoc(doc(db, "internal_admins", user.uid));
                if (adminDoc.exists()) {
                    document.getElementById('login-screen').classList.add('hidden');
                    initSystem();
                } else { await signOut(auth); }
            } else { document.getElementById('login-screen').classList.remove('hidden'); }
            lucide.createIcons();
        });

        window.handleSignOut = () => signOut(auth).then(() => window.location.reload());

        // --- INITIALIZATION ---
        function initSystem() {
            // Configura√ß√µes
            onSnapshot(doc(db, "config_superadmin", "notifications"), (d) => { if(d.exists()){config=d.data(); updateAudioUI();} });

            // Planos
            onSnapshot(collection(db, "config_plans"), (snap) => {
                availablePlans = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderPlansUI();
                renderPlanSelects();
            });

            // Lojas Registradas
            onSnapshot(collection(db, "stores_registry"), async (snap) => {
                const raw = snap.docs.map(d => ({...d.data(), slug: d.id}));
                document.getElementById('syncStatus').innerText = "Analisando Performance...";
                await fetchAnalyticsForSort(raw);
                allStores = raw;
                document.getElementById('syncStatus').innerText = "Sincronizado";
                processAndRender();
            });

            // Solicita√ß√µes
            onSnapshot(collection(db, "registration_requests"), (snap) => {
                const badge = document.getElementById('reqCountBadge');
                badge.textContent = snap.size; badge.classList.toggle('hidden', snap.size === 0);
                document.getElementById('emptyRequests').classList.toggle('hidden', snap.size > 0);
                if(lastRequestCount !== -1 && snap.size > lastRequestCount && config.audioAlert) new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3').play().catch(()=>{});
                lastRequestCount = snap.size;
                renderRequests(snap.docs.map(d => ({id: d.id, ...d.data()})));
            });
        }

        // --- ANALYTICS CACHE ENGINE ---
        async function fetchAnalyticsForSort(stores) {
            const now = new Date();
            const todayId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            const sevenDays = now.getTime() - (7 * 24 * 60 * 60 * 1000);
            const thirtyDays = now.getTime() - (30 * 24 * 60 * 60 * 1000);

            const promises = stores.map(async (s) => {
                if (analyticsCache[s.slug]) return;
                try {
                    const global = await getDoc(doc(db, `stores/${s.slug}/analytics/global`));
                    const total = global.exists() ? (global.data().totalVisits || 0) : 0;
                    
                    const history = await getDocs(query(collection(db, `stores/${s.slug}/analytics_history`), orderBy('date', 'desc'), limit(30)));
                    let day = 0, week = 0, month = 0;
                    
                    history.forEach(doc => {
                        const d = doc.data();
                        const v = d.visits || 0;
                        const time = (d.date?.toDate ? d.date.toDate() : new Date(d.date)).getTime();
                        if (doc.id === todayId) day = v;
                        if (time >= sevenDays) week += v;
                        if (time >= thirtyDays) month += v;
                    });
                    analyticsCache[s.slug] = { day, week, month, total };
                } catch(e) { analyticsCache[s.slug] = { day: 0, week: 0, month: 0, total: 0 }; }
            });
            await Promise.all(promises);
        }

        // --- DASHBOARD CONTROLS ---
        window.setSort = (crit) => {
            currentSort = crit;
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.id === `sort-${crit}`));
            processAndRender();
        };

        window.toggleGrouping = () => {
            isGrouped = !isGrouped;
            const btn = document.getElementById('btnGroup');
            btn.classList.toggle('text-indigo-400', isGrouped);
            btn.classList.toggle('text-slate-400', !isGrouped);
            processAndRender();
        };

        function processAndRender() {
            let list = [...allStores];
            list.sort((a, b) => {
                const sA = analyticsCache[a.slug] || {day:0, week:0, month:0, total:0};
                const sB = analyticsCache[b.slug] || {day:0, week:0, month:0, total:0};
                switch(currentSort) {
                    case 'name': return a.storeName.localeCompare(b.storeName);
                    case 'date': return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                    case 'day': return sB.day - sA.day;
                    case 'week': return sB.week - sA.week;
                    case 'month': return sB.month - sA.month;
                    case 'total': return sB.total - sA.total;
                    default: return 0;
                }
            });
            isGrouped ? renderGroupedTable(list) : renderStoreTable(list);
        }

        // --- UI RENDERERS ---
        function renderStoreTable(list) {
            const tbody = document.getElementById('storesTableBody');
            if (!list.length) { tbody.innerHTML = `<tr><td colspan="6" class="p-16 text-center text-slate-500 italic">Nenhum registro encontrado.</td></tr>`; return; }
            tbody.innerHTML = list.map(s => buildRowMarkup(s)).join('');
            lucide.createIcons();
        }

        function renderGroupedTable(list) {
            const tbody = document.getElementById('storesTableBody');
            const groups = list.reduce((acc, s) => {
                const p = s.planId || 'Sem Plano';
                if (!acc[p]) acc[p] = [];
                acc[p].push(s);
                return acc;
            }, {});
            let html = '';
            Object.keys(groups).forEach(p => {
                html += `<tr class="group-header"><td colspan="6" class="px-8 py-4 text-[10px] font-black text-indigo-400 uppercase tracking-widest border-l-4 border-indigo-600">PLANO: ${p} (${groups[p].length} unidades)</td></tr>`;
                html += groups[p].map(s => buildRowMarkup(s)).join('');
            });
            tbody.innerHTML = html;
            lucide.createIcons();
        }

        function buildRowMarkup(s) {
            const stats = analyticsCache[s.slug] || {day:0, week:0, month:0, total:0};
            return `
                <tr class="border-b border-slate-800/50 hover:bg-slate-900/30 transition-all">
                    <td class="px-4 py-6 text-center">
                        <button onclick="toggleStoreDetails('${s.slug}')" class="p-2 hover:bg-slate-800 rounded-lg text-slate-500 transition-transform chevron-rotate" id="btn-exp-${s.slug}">
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </td>
                    <td class="px-8 py-6">
                        <div class="flex flex-col">
                            <span class="font-bold text-white">${s.storeName}</span>
                            <span class="text-[9px] text-slate-500 font-mono tracking-tighter">${s.slug}</span>
                        </div>
                    </td>
                    <td class="px-8 py-6"><span class="bg-indigo-500/10 text-indigo-400 text-[9px] font-black px-2 py-0.5 rounded border border-indigo-500/20 uppercase">${s.planId}</span></td>
                    <td class="px-8 py-6">
                        <div class="flex items-center gap-3">
                            <span class="text-white font-black text-sm">${stats.month}</span>
                            <div class="w-16 h-1 bg-slate-800 rounded-full overflow-hidden">
                                <div class="bg-indigo-500 h-full" style="width: ${Math.min((stats.month/500)*100, 100)}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-8 py-6 text-[10px] font-bold uppercase ${s.status === 'active' ? 'text-green-400' : 'text-red-400'}">
                        <div class="flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full ${s.status === 'active' ? 'bg-green-400 animate-pulse' : 'bg-red-400'}"></span>${s.status}</div>
                    </td>
                    <td class="px-8 py-6 text-right flex gap-3 justify-end">
                        <button onclick='openEditModal(${JSON.stringify(s)})' class="p-2.5 text-indigo-400 hover:bg-indigo-900/30 rounded-xl transition-colors"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="toggleSuspend('${s.slug}', '${s.status}')" class="p-2.5 ${s.status === 'suspended' ? 'text-green-400' : 'text-slate-500'} hover:bg-slate-800 rounded-xl transition-colors"><i data-lucide="power" class="w-4 h-4"></i></button>
                        <button onclick="deleteStore('${s.slug}')" class="p-2.5 text-slate-600 hover:text-red-500 rounded-xl transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
                <tr id="details-${s.slug}" class="hidden bg-slate-950/80">
                    <td colspan="6" class="px-12 py-10 border-l-4 border-indigo-600">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 animate-pop-in">
                            <div class="bg-slate-900 p-5 rounded-3xl border border-slate-800">
                                <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Hoje</p>
                                <h4 class="text-3xl font-bold text-white">${stats.day}</h4>
                            </div>
                            <div class="bg-slate-900 p-5 rounded-3xl border border-slate-800">
                                <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Semana</p>
                                <h4 class="text-3xl font-bold text-indigo-400">${stats.week}</h4>
                            </div>
                            <div class="bg-slate-900 p-5 rounded-3xl border border-slate-800">
                                <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">M√™s</p>
                                <h4 class="text-3xl font-bold text-pink-500">${stats.month}</h4>
                            </div>
                            <div class="bg-slate-900 p-5 rounded-3xl border border-slate-800">
                                <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Geral</p>
                                <h4 class="text-3xl font-bold text-indigo-200">${stats.total}</h4>
                            </div>
                        </div>
                        <div class="mt-6 flex flex-wrap gap-8 text-[10px] text-slate-500 uppercase font-black tracking-widest">
                            <div class="flex items-center gap-2"><i data-lucide="mail" class="w-3.5 h-3.5"></i> EMAIL: <span class="text-slate-300 font-mono">${s.ownerEmail}</span></div>
                            <div class="flex items-center gap-2"><i data-lucide="phone" class="w-3.5 h-3.5"></i> WHATSAPP: <span class="text-slate-300 font-mono">${s.ownerPhone || 'N/A'}</span></div>
                            <div class="flex items-center gap-2"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> VENCIMENTO: <span class="text-slate-300 font-mono">DIA ${s.billingDay || 10}</span></div>
                        </div>
                    </td>
                </tr>
            `;
        }

        // --- PLANOS UI ---
        function renderPlansUI() {
            document.getElementById('plansGrid').innerHTML = availablePlans.map(p => `
                <div class="bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] flex flex-col h-full shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-indigo-600/20 text-indigo-400 px-4 py-1 text-[8px] font-black uppercase tracking-widest rounded-bl-xl">${p.hasCarousel ? 'Com Carrossel' : 'Sem Carrossel'}</div>
                    <h3 class="font-bold text-white text-xl mb-1">${p.name}</h3>
                    <span class="text-pink-500 text-xs font-black uppercase mb-6">${formatBRL(p.price)} / m√™s</span>
                    <div class="space-y-3 mb-8 flex-1">
                        <div class="flex items-center gap-2 text-[10px] text-slate-400 font-bold uppercase"><i data-lucide="package" class="w-3.5 h-3.5"></i> ${p.maxProducts} Produtos</div>
                        <div class="flex items-center gap-2 text-[10px] text-slate-400 font-bold uppercase"><i data-lucide="layout" class="w-3.5 h-3.5"></i> ${p.maxBanners} Banners</div>
                        <div class="pt-4 border-t border-slate-800 text-[10px] text-slate-500 leading-relaxed">${(p.features || '').split('\n').map(f => `‚Ä¢ ${f}`).join('<br>')}</div>
                    </div>
                    <div class="flex gap-2 pt-6 border-t border-slate-800">
                        <button onclick='openPlanModal(${JSON.stringify(p)})' class="flex-1 bg-slate-800 hover:bg-slate-700 text-[10px] font-black uppercase py-3 rounded-2xl transition-all">Editar</button>
                        <button onclick="deletePlan('${p.id}')" class="p-3 text-slate-500 hover:text-red-500 hover:bg-red-500/10 rounded-2xl transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`).join('');
            lucide.createIcons();
        }

        // --- SOLICITA√á√ïES UI ---
        function renderRequests(list) {
            document.getElementById('requestsList').innerHTML = list.map(r => {
                const p = availablePlans.find(pl => pl.id === r.planId) || {name: 'Manual'};
                return `
                <div class="bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] shadow-xl hover:border-indigo-500/40 transition-all group">
                    <div class="flex justify-between items-start mb-6">
                        <span class="bg-indigo-600/10 text-indigo-500 text-[9px] font-black uppercase tracking-widest px-3 py-1 rounded-full border border-indigo-500/20">Solicita√ß√£o</span>
                        <span class="text-[9px] text-slate-600 font-mono tracking-tighter">#${r.id.slice(-5).toUpperCase()}</span>
                    </div>
                    <h4 class="text-white font-bold text-xl mb-1 truncate">${r.storeName}</h4>
                    <p class="text-slate-400 text-xs mb-6 flex items-center gap-2"><i data-lucide="mail" class="w-3 h-3"></i> ${r.email}</p>
                    
                    <div class="space-y-3 py-4 border-y border-slate-800/50 mb-6">
                        <div class="flex justify-between items-center text-[10px] font-bold uppercase"><span class="text-slate-500">Respons√°vel:</span><span class="text-white">${r.ownerName || 'N/A'}</span></div>
                        <div class="flex justify-between items-center text-[10px] font-bold uppercase"><span class="text-slate-500">WhatsApp:</span><span class="text-indigo-400">${r.phone || 'N/A'}</span></div>
                        <div class="flex justify-between items-center text-[10px] font-bold uppercase"><span class="text-slate-500">Plano Alvo:</span><span class="text-pink-500">${p.name}</span></div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick='approveRequest(${JSON.stringify(r).replace(/'/g, "&#39;")})' class="flex-1 bg-indigo-600 hover:bg-indigo-500 py-3.5 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg transition-all">Analisar & Ativar</button>
                        <button onclick="deleteRequest('${r.id}')" class="p-3.5 text-slate-500 hover:text-red-500 hover:bg-red-500/10 rounded-2xl transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- HANDLERS ---
        window.toggleStoreDetails = (slug) => {
            const row = document.getElementById(`details-${slug}`);
            const btn = document.getElementById(`btn-exp-${slug}`);
            if(!row.classList.contains('hidden')) {
                row.classList.add('hidden');
                btn.classList.remove('chevron-active');
            } else {
                row.classList.remove('hidden');
                btn.classList.add('chevron-active');
            }
        };

        window.handleSearch = (v) => {
            const term = v.toLowerCase();
            const filtered = allStores.filter(s => s.storeName.toLowerCase().includes(term) || s.slug.toLowerCase().includes(term));
            renderStoreTable(filtered);
        };

        window.approveRequest = (r) => {
            document.getElementById('requestId').value = r.id;
            document.getElementById('storeName').value = r.storeName;
            document.getElementById('adminEmail').value = r.email;
            document.getElementById('storeSlug').value = (r.storeName || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '-');
            document.getElementById('adminPass').value = Math.random().toString(36).slice(-8);
            document.getElementById('storePhone').value = r.phone || '';
            const matched = availablePlans.find(p => p.id === r.planId || p.name === r.planId);
            if(matched) document.getElementById('storePlan').value = matched.id;
            switchView('create');
        };

                // --- FORM ACTIONS ---
        // --- Procure o listener do 'createStoreForm' no seu <script> ---

document.getElementById('createStoreForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true; 
    btn.innerHTML = '<span class="animate-pulse">Provisionando...</span>';
    
    const pId = document.getElementById('storePlan').value;
    const plan = availablePlans.find(p => p.id === pId);
    
    // Captura os novos campos
    const isBetaChecked = document.getElementById('createIsBeta').checked;
    const expiryValue = document.getElementById('createExpiryDate').value;

    const slug = document.getElementById('storeSlug').value;
    const email = document.getElementById('adminEmail').value;
    const pass = document.getElementById('adminPass').value;
    const name = document.getElementById('storeName').value;
    const phone = document.getElementById('storePhone').value;
    const rid = document.getElementById('requestId').value;

    // C√°lculo de Data Padr√£o (Se n√£o preencher, d√° 30 dias)
    let finalExpiry;
    if (expiryValue) {
        finalExpiry = new Date(expiryValue + "T12:00:00");
    } else {
        const d = new Date();
        d.setDate(d.getDate() + 30);
        finalExpiry = d;
    }

    const secApp = initializeApp(firebaseConfig, "provisioning_app_" + Date.now());
    const secAuth = getAuth(secApp);

    try {
        const cred = await createUserWithEmailAndPassword(secAuth, email, pass);

        const storeData = { 
            storeName: name, 
            ownerEmail: email, 
            ownerPhone: phone, 
            
            // L√≥gica Beta vs Plano
            planId: isBetaChecked ? 'beta_tester' : plan.name,
            isBeta: isBetaChecked,
            expiryDate: finalExpiry, // Salva a data de validade

            // Benef√≠cios Herdados (Cascata)
            maxProducts: parseInt(plan.maxProducts), 
            maxBanners: parseInt(plan.maxBanners),
            hasCarousel: plan.hasCarousel === true,
            hasFinance: plan.hasFinance === true,
            hasMagicCategories: plan.hasMagicCategories === true,

            status: 'active', 
            subscriptionStatus: 'active',
            isStoreOpen: true, 
            billingDay: 10, 
            createdAt: serverTimestamp(),
            lastUpdate: Date.now()
        };

        // Grava√ß√µes no Firestore
        await setDoc(doc(db, "stores", slug, "config", "store"), storeData);
        await setDoc(doc(db, "admin_directory", cred.user.uid), { storeId: slug, role: 'owner' });
        await setDoc(doc(db, "stores_registry", slug), { ...storeData, slug });

        if(rid) await deleteDoc(doc(db, "registration_requests", rid));
        
        // Sucesso e Notifica√ß√£o WhatsApp
        document.getElementById('resEmail').innerText = email; 
        document.getElementById('resPass').innerText = pass;
        document.getElementById('btnWhatsAppNotify').onclick = () => {
            const msg = `üöÄ *Sua Vitrine est√° ATIVA!*\n\nAcesse: https://danielnqtfreitas-hash.github.io/Painel/\nLogin: ${email}\nSenha: ${pass}\nValidade: ${finalExpiry.toLocaleDateString('pt-BR')}`;
            window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`,'_blank');
        };
        
        await signOut(secAuth); 
        await deleteApp(secApp); 
        switchView('result-view');

    } catch (err) { 
        alert("Erro: " + err.message); 
        await deleteApp(secApp); 
    } finally {
        btn.disabled = false; 
        btn.innerHTML = 'Confirmar e Gerar Acesso';
    }
});



        window.savePlan = async (e) => {
    e.preventDefault(); // Impede a p√°gina de recarregar
    
    const id = document.getElementById('planId').value || 'plan_' + Date.now();
    const btn = document.getElementById('btnSavePlan');
    btn.disabled = true;

    // 1. Aqui n√≥s capturamos os valores dos campos do formul√°rio
    const planData = {
        name: document.getElementById('planName').value,
        price: parseFloat(document.getElementById('planPrice').value) || 0,
        maxProducts: parseInt(document.getElementById('planMaxProducts').value) || 0,
        maxBanners: parseInt(document.getElementById('planMaxBanners').value) || 0,
        
        // ESTES S√ÉO OS NOVOS CAMPOS (OS CHECKBOXES)
        hasCarousel: document.getElementById('planHasCarousel').checked,
        hasFinance: document.getElementById('planHasFinance').checked,
        hasMagicCategories: document.getElementById('planHasMagic').checked,
        
        features: document.getElementById('planFeatures').value, // Descri√ß√£o que aparece no registro
        updatedAt: Date.now()
    };

    try {
        // 2. Salvamos na cole√ß√£o de planos p√∫blicos
        await setDoc(doc(db, "public_plans", id), planData);
        
        alert("Plano configurado com sucesso! Agora as lojas que assinarem este plano herdar√£o estas travas.");
        closePlanModal(); // Fecha o modal de cria√ß√£o de planos
    } catch (error) {
        console.error("Erro ao salvar plano:", error);
        alert("Erro ao salvar o plano.");
    } finally {
        btn.disabled = false;
    }
};


        window.saveStoreEdit = async (e) => {
    e.preventDefault();

    const slug = document.getElementById('editSlug').value;
    const planIdSelected = document.getElementById('editPlan').value;
    const plan = availablePlans.find(p => p.id === planIdSelected);

    if (!plan) {
        alert("Selecione um plano v√°lido.");
        return;
    }

    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;

    // Criamos o objeto HERDANDO tudo do plano (A CASCATA)
    const data = {
        storeName: document.getElementById('editName').value,
        ownerEmail: document.getElementById('editEmail').value,
        planId: plan.name,
        
        // Limites herdados do molde do plano
        maxProducts: parseInt(plan.maxProducts),
        maxBanners: parseInt(plan.maxBanners),
        hasCarousel: plan.hasCarousel === true,
        hasFinance: plan.hasFinance === true,
        hasMagicCategories: plan.hasMagicCategories === true,
        
        billingDay: parseInt(document.getElementById('editBillingDay').value),
        lastUpdate: Date.now()
    };

    try {
        // Atualiza o registro do Admin
        await updateDoc(doc(db, "stores_registry", slug), data);
        // Atualiza a configura√ß√£o que o Painel do Lojista escuta em tempo real
        await updateDoc(doc(db, "stores", slug, "config", "store"), data);
        
        alert("‚úÖ Loja e Recursos atualizados com sucesso!");
        closeEditModal();
    } catch (err) {
        console.error(err);
        alert("Erro ao atualizar: " + err.message);
    } finally {
        btn.disabled = false;
    }
};

        // --- NAVIGATION & UTILS ---
        window.switchView = (v) => {
            ['list', 'requests', 'plans', 'create', 'result-view', 'settings'].forEach(x => {
                if(document.getElementById(`view-${x}`)) document.getElementById(`view-${x}`).classList.add('hidden');
                if(document.getElementById(`nav-${x}`)) document.getElementById(`nav-${x}`).classList.remove('bg-indigo-600/10', 'text-indigo-400', 'border-indigo-600/50');
            });
            if(document.getElementById(`view-${v}`)) document.getElementById(`view-${v}`).classList.remove('hidden');
            if(document.getElementById(`nav-${v}`)) document.getElementById(`nav-${v}`).classList.add('bg-indigo-600/10', 'text-indigo-400', 'border-indigo-600/50');
            if(window.innerWidth < 768) toggleSidebar();
        };

        function renderPlanSelects() {
            const sSelect = document.getElementById('storePlan');
            const eSelect = document.getElementById('editPlan');
            sSelect.innerHTML = '<option value="">Selecione um Plano...</option>';
            eSelect.innerHTML = '';
            availablePlans.forEach(p => {
                const opt = `<option value="${p.id}">${p.name} (${formatBRL(p.price)})</option>`;
                sSelect.insertAdjacentHTML('beforeend', opt);
                eSelect.insertAdjacentHTML('beforeend', opt);
            });
        }

        window.openPlanModal = (p = null) => {
    document.getElementById('planId').value = p?.id || '';
    document.getElementById('planName').value = p?.name || '';
    document.getElementById('planPrice').value = p?.price || '';
    document.getElementById('planMaxProducts').value = p?.maxProducts || '';
    document.getElementById('planMaxBanners').value = p?.maxBanners || 1;
    document.getElementById('planFeatures').value = p?.features || '';
    
    // Carrega os novos Checkboxes
    document.getElementById('planHasFinance').checked = p?.hasFinance === true;
    document.getElementById('planHasMagic').checked = p?.hasMagicCategories === true;
    document.getElementById('planHasCarousel').checked = p?.hasCarousel === true;

    document.getElementById('plan-modal').classList.remove('hidden');
    lucide.createIcons();
};




        window.closePlanModal = () => document.getElementById('plan-modal').classList.add('hidden');
        
        window.openEditModal = (s) => {
    // 1. Limpa e preenche os campos b√°sicos
    document.getElementById('editSlug').value = s.slug || '';
    document.getElementById('editName').value = s.storeName || '';
    document.getElementById('editEmail').value = s.ownerEmail || '';
    document.getElementById('editBillingDay').value = s.billingDay || 10;
    
    // 2. Tratamento da Data (Convers√£o do Firebase para o Input)
    if (s.expiryDate) {
        const d = s.expiryDate.toDate ? s.expiryDate.toDate() : new Date(s.expiryDate);
        document.getElementById('editExpiryDate').value = d.toISOString().split('T')[0];
    } else {
        document.getElementById('editExpiryDate').value = '';
    }

    // 3. Status Beta
    document.getElementById('editIsBeta').checked = (s.planId === 'beta_tester' || s.isBeta === true);

    // 4. Seleciona o Plano no Dropdown
    const selectPlan = document.getElementById('editPlan');
    const matchedPlan = availablePlans.find(pl => pl.name === s.planId);
    if (matchedPlan) {
        selectPlan.value = matchedPlan.id;
    } else {
        selectPlan.value = ""; // Caso seja beta sem plano definido
    }

    document.getElementById('edit-modal').classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

window.saveStoreEdit = async (e) => {
    e.preventDefault();

    const slug = document.getElementById('editSlug').value;
    const planIdSelected = document.getElementById('editPlan').value;
    const plan = availablePlans.find(p => p.id === planIdSelected);

    const isBetaChecked = document.getElementById('editIsBeta').checked;
    const expiryValue = document.getElementById('editExpiryDate').value;

    // Se n√£o for Beta, OBRIGAT√ìRIO ter um plano
    if (!isBetaChecked && !plan) {
        alert("Por favor, selecione um plano para esta loja.");
        return;
    }

    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "Sincronizando...";

    try {
        // Criamos o objeto de dados com prote√ß√µes (Fallback)
        // Se for beta e n√£o tiver plano, damos limites altos por padr√£o
        const data = {
            storeName: document.getElementById('editName').value,
            ownerEmail: document.getElementById('editEmail').value,
            planId: isBetaChecked ? 'beta_tester' : (plan ? plan.name : 'padr√£o'),
            isBeta: isBetaChecked,
            
            // Converte Data
            expiryDate: expiryValue ? new Date(expiryValue + "T12:00:00") : null,
            
            // Limites (usa o plano se existir, sen√£o usa padr√£o de 999 para Beta)
            maxProducts: plan ? parseInt(plan.maxProducts) : 999,
            maxBanners: plan ? parseInt(plan.maxBanners) : 5,
            hasCarousel: plan ? (plan.hasCarousel === true) : true,
            hasFinance: plan ? (plan.hasFinance === true) : true,
            hasMagicCategories: plan ? (plan.hasMagicCategories === true) : true,
            
            billingDay: parseInt(document.getElementById('editBillingDay').value) || 10,
            lastUpdate: Date.now()
        };

        // 3. Grava√ß√£o Dupla (Registro e Config da Loja)
        await updateDoc(doc(db, "stores_registry", slug), data);
        await updateDoc(doc(db, "stores", slug, "config", "store"), data);
        
        alert("‚úÖ Loja atualizada com sucesso!");
        closeEditModal();
    } catch (err) {
        console.error("Erro na sincroniza√ß√£o:", err);
        alert("Erro ao salvar altera√ß√µes. Verifique sua conex√£o.");
    } finally {
        // SEMPRE devolve o bot√£o ao estado original
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
};


        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

        window.deleteStore = async (s) => { if(confirm("Apagar UNIDADE permanentemente? Esta a√ß√£o n√£o pode ser desfeita.")) await deleteDoc(doc(db, "stores_registry", s)); };
        window.deletePlan = async (id) => { if(confirm("Apagar PLANO?")) await deleteDoc(doc(db, "config_plans", id)); };
        window.deleteRequest = async (id) => { if(confirm("Apagar solicita√ß√£o?")) await deleteDoc(doc(db, "registration_requests", id)); };
        window.publishPlansForRegistration = async () => {
            const pubRef = collection(db, "public_plans");
            const snap = await getDocs(pubRef);
            await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
            await Promise.all(availablePlans.map(p => setDoc(doc(pubRef, p.id), {...p, isActive: true})));
            alert("Sincronizado com o site p√∫blico!");
        };
        window.toggleSuspend = async (slug, curr) => {
    const isSuspended = curr === 'suspended';
    const nextStatus = isSuspended ? 'active' : 'suspended';
    
    const confirmMsg = isSuspended 
        ? "Deseja REATIVAR esta loja? O lojista voltar√° a ter acesso ao painel." 
        : "Deseja SUSPENDER esta loja? O lojista ser√° bloqueado imediatamente.";

    if (!confirm(confirmMsg)) return;

    try {
        // 1. Atualiza no registro administrativo
        await updateDoc(doc(db, "stores_registry", slug), { 
            status: nextStatus 
        });

        // 2. Atualiza na configura√ß√£o da loja (Onde o lojista "escuta")
        await updateDoc(doc(db, "stores", slug, "config", "store"), { 
            subscriptionStatus: nextStatus,
            lastUpdate: Date.now() 
        });

        alert(`Loja ${isSuspended ? 'ativada' : 'suspensa'} com sucesso!`);
    } catch (e) {
        console.error("Erro ao mudar status:", e);
        alert("Erro t√©cnico ao tentar mudar o status.");
    }
};

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');
        window.toggleAudioAlert = () => { config.audioAlert = !config.audioAlert; saveConfig(); };
        async function saveConfig() { await setDoc(doc(db, "config_superadmin", "notifications"), config); updateAudioUI(); }
        function updateAudioUI() {
            const btn = document.getElementById('btnToggleAudio'); if(!btn) return;
            btn.innerHTML = `<i data-lucide="${config.audioAlert ? 'volume-2' : 'volume-x'}" class="w-5 h-5"></i> <span>Notifica√ß√µes: ${config.audioAlert ? 'ATIVADAS' : 'MUDO'}</span>`;
            btn.className = `w-full py-4 px-6 rounded-2xl border flex items-center justify-center gap-3 font-bold text-xs uppercase ${config.audioAlert ? 'bg-indigo-600/20 text-indigo-400 border-indigo-600/30' : 'bg-slate-800 text-slate-500 border-slate-700'}`;
            lucide.createIcons();
        }

        // Adicione isso no final do seu script para o showToast funcionar
window.showToast = (msg) => {
    alert(msg); // Por enquanto, o alert resolve, ou voc√™ pode criar um elemento HTML para isso
};


    </script>
</body>
</html> 
