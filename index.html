<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin | Marketplace Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        /* Table Scroll Fix */
        .table-container {
            overflow-x: auto;
            scrollbar-width: thin;
            -webkit-overflow-scrolling: touch;
        }

        .modal-blur { backdrop-filter: blur(12px); background: rgba(2, 6, 23, 0.85); }
        
        .input-premium {
            width: 100%;
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 1rem;
            padding: 0.85rem 1.25rem;
            color: white;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-premium:focus { 
            border-color: #6366f1; 
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
            background-color: #0f172a;
        }
        
        .btn-hover { transition: all 0.2s ease; }
        .btn-hover:hover { transform: translateY(-1px); filter: brightness(1.1); }
        
        .animate-pop-in { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        #login-screen { background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.2), transparent), #020617; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 h-screen flex overflow-hidden w-full">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[200] flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-800 p-10 rounded-[3rem] max-w-md w-full shadow-2xl animate-pop-in">
            <div class="flex flex-col items-center text-center mb-10">
                <div class="bg-indigo-600 p-5 rounded-[2rem] shadow-xl mb-5">
                    <i data-lucide="shield-check" class="w-12 h-12 text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Super Admin</h1>
                <p class="text-slate-400 text-sm mt-2">√Årea Restrita - Acesso √önico</p>
            </div>
            <form id="loginForm" class="space-y-5">
                <input type="email" id="loginEmail" required class="input-premium" placeholder="admin@sistema.com">
                <input type="password" id="loginPassword" required class="input-premium" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <div id="loginError" class="hidden p-4 bg-red-500/10 border border-red-500/30 rounded-2xl text-red-500 text-xs text-center font-bold">Acesso negado.</div>
                <button type="submit" id="btnLogin" class="w-full py-4.5 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-2xl shadow-lg transition-all btn-hover h-14 text-sm uppercase tracking-widest">Aceder ao Painel</button>
            </form>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 border-r border-slate-800 z-50 transform -translate-x-full md:translate-x-0 md:relative flex flex-col transition-transform duration-300">
        <div class="h-20 flex items-center justify-between px-6 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-xl"><i data-lucide="shield" class="w-5 h-5 text-white"></i></div>
                <span class="font-bold text-lg">Super Admin</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchView('list')" id="nav-list" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-sm font-medium transition-all bg-indigo-600/10 text-indigo-400 border border-indigo-600/50"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard</button>
            <button onclick="switchView('requests')" id="nav-requests" class="w-full flex items-center justify-between px-4 py-3.5 rounded-2xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all">
                <div class="flex items-center gap-3"><i data-lucide="user-plus" class="w-5 h-5"></i> Solicita√ß√µes</div>
                <span id="reqCountBadge" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded-full">0</span>
            </button>
            <button onclick="switchView('plans')" id="nav-plans" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all"><i data-lucide="package" class="w-5 h-5"></i> Planos</button>
            <button onclick="switchView('create')" id="nav-create" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all"><i data-lucide="plus-circle" class="w-5 h-5"></i> Novo Cadastro</button>
            <button onclick="switchView('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all"><i data-lucide="bell" class="w-5 h-5"></i> Notifica√ß√µes</button>
        </nav>
        <div class="p-6 border-t border-slate-800">
            <button onclick="handleSignOut()" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 hover:text-red-400 text-xs font-black uppercase tracking-widest"><i data-lucide="log-out" class="w-4 h-4"></i> Sair</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-950 w-full">
        <header class="h-20 flex items-center justify-between px-6 md:px-10 border-b border-slate-800 bg-slate-950/50 backdrop-blur-md z-40">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-300 bg-slate-900 rounded-xl"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <h2 id="viewTitle" class="text-xl font-bold text-white tracking-tight">Gest√£o de Lojas</h2>
            </div>
            <div class="hidden md:flex items-center gap-2 px-4 py-2 bg-indigo-600/10 border border-indigo-600/30 rounded-full">
                <span class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span>
                <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Sincronizado</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-6xl mx-auto pb-24">
                
                <!-- VIEW: LISTA -->
                <div id="view-list" class="animate-fade-in space-y-8">
                    <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center gap-6">
                        <div><h3 class="text-2xl font-bold text-white">Unidades Ativas</h3><p class="text-sm text-slate-500">Controle administrativo total</p></div>
                        <div class="relative w-full sm:w-80">
                            <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-slate-500"></i>
                            <input type="text" id="searchInput" oninput="handleSearch(this.value)" placeholder="Filtrar por nome..." class="input-premium pl-12">
                        </div>
                    </div>
                    
                    <div class="table-container bg-slate-900/50 rounded-[2.5rem] border border-slate-800 shadow-2xl">
                        <table class="w-full text-left text-sm min-w-[900px]">
                            <thead class="bg-slate-900 text-slate-400 text-[10px] uppercase font-black tracking-widest">
                                <tr>
                                    <th class="px-8 py-6">Loja / Slug</th>
                                    <th class="px-8 py-6">Assinatura</th>
                                    <th class="px-8 py-6">E-mail Oficial</th>
                                    <th class="px-8 py-6">Status</th>
                                    <th class="px-8 py-6 text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="storesTableBody" class="divide-y divide-slate-800/50">
                                <tr><td colspan="5" class="p-16 text-center text-slate-500 italic">Carregando dados...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: REQUESTS -->
                <div id="view-requests" class="hidden animate-fade-in">
                    <div class="mb-10"><h2 class="text-2xl font-bold text-white">Solicita√ß√µes de Ades√£o</h2><p class="text-sm text-slate-500">Leads vindos do formul√°rio de pr√©-cadastro</p></div>
                    <div id="requestsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="emptyRequests" class="hidden text-center py-20 bg-slate-900 rounded-[3rem] border border-slate-800">
                        <i data-lucide="inbox" class="w-12 h-12 text-slate-700 mx-auto mb-4"></i>
                        <p class="text-slate-500">Nenhuma solicita√ß√£o pendente.</p>
                    </div>
                </div>

                <!-- VIEW: PLANS -->
                <div id="view-plans" class="hidden animate-fade-in">
                    <div class="flex justify-between items-center mb-10">
                        <div><h2 class="text-2xl font-bold text-white">Cat√°logo de Planos</h2><p class="text-sm text-slate-500">Configure as ofertas para o mercado</p></div>
                        <div class="flex gap-3">
                            <button onclick="publishPlansForRegistration()" class="bg-slate-800 text-white px-6 py-3 rounded-2xl text-xs font-bold border border-slate-700 transition-all hover:bg-slate-700">Publicar para Cadastro</button>
                            <button onclick="openPlanModal()" class="bg-pink-600 text-white px-6 py-3 rounded-2xl text-xs font-bold shadow-lg shadow-pink-600/20 btn-hover">Novo Plano</button>
                        </div>
                    </div>
                    <div id="plansGrid" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
                </div>

                <!-- VIEW: CREATE -->
                <div id="view-create" class="hidden animate-fade-in max-w-2xl mx-auto">
                    <div class="mb-10 text-center"><h2 class="text-3xl font-bold text-white">Ativar Vitrine</h2><p class="text-sm text-slate-500">Cria√ß√£o do acesso administrativo oficial</p></div>
                    <form id="createStoreForm" class="bg-slate-900 border border-slate-800 p-10 rounded-[3.5rem] space-y-8 shadow-2xl">
                        <input type="hidden" id="requestId">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2 space-y-1.5"><label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Plano de Assinatura</label><select id="storePlan" required class="input-premium bg-slate-800"></select></div>
                            <div class="space-y-1.5"><label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Nome da Loja</label><input type="text" id="storeName" required class="input-premium"></div>
                            <div class="space-y-1.5"><label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Slug URL (Pasta)</label><input type="text" id="storeSlug" required class="input-premium font-mono"></div>
                            <div class="space-y-1.5"><label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Email do Lojista</label><input type="email" id="adminEmail" required class="input-premium"></div>
                            <div class="space-y-1.5"><label class="text-[10px] font-bold text-slate-500 uppercase ml-2">WhatsApp</label><input type="text" id="storePhone" required class="input-premium"></div>
                            <div class="md:col-span-2 space-y-1.5"><label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Senha de Acesso</label><input type="text" id="adminPass" required class="input-premium font-mono"></div>
                        </div>
                        <button type="submit" id="btnSubmitStore" class="w-full bg-indigo-600 text-white font-bold py-5 rounded-3xl shadow-xl transition-all btn-hover uppercase tracking-widest text-xs">Confirmar e Gerar Acesso</button>
                    </form>
                </div>

                <!-- VIEW: RESULT -->
                <div id="view-result-view" class="hidden animate-fade-in max-w-md mx-auto text-center space-y-8">
                    <div class="bg-green-500/10 border border-green-500/30 rounded-[3.5rem] p-10 shadow-2xl">
                        <div class="w-20 h-20 bg-green-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg"><i data-lucide="check" class="text-white w-10 h-10"></i></div>
                        <h3 class="text-2xl font-bold text-white mb-2">Vitrine Criada!</h3>
                        <div class="bg-slate-950 p-6 rounded-3xl text-left text-xs font-mono space-y-3 border border-slate-800">
                            <p class="flex justify-between"><span>LOGIN:</span> <span id="resEmail" class="text-green-400 font-bold"></span></p>
                            <p class="flex justify-between"><span>PASS:</span> <span id="resPass" class="text-indigo-400 font-bold"></span></p>
                        </div>
                        <button id="btnWhatsAppNotify" class="w-full bg-[#25D366] text-white font-bold py-5 rounded-3xl mt-8 flex justify-center items-center gap-3 shadow-lg btn-hover"><i data-lucide="message-circle" class="w-6 h-6"></i> Enviar via WhatsApp</button>
                    </div>
                </div>

                <!-- VIEW: SETTINGS -->
                <div id="view-settings" class="hidden animate-fade-in">
                    <h2 class="text-2xl font-bold text-white mb-10">Configura√ß√µes do Painel</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-slate-900 border border-slate-800 p-8 rounded-[3rem] flex flex-col justify-between">
                            <div><h4 class="font-bold text-white">Notifica√ß√µes Sonoras</h4><p class="text-xs text-slate-500 mt-2">Alerta ac√∫stico para novas solicita√ß√µes</p></div>
                            <button onclick="toggleAudioAlert()" id="btnToggleAudio" class="mt-8 py-4 px-6 rounded-2xl border flex items-center justify-center gap-3 font-bold text-xs uppercase transition-all"></button>
                        </div>
                        <div class="bg-slate-900 border border-slate-800 p-8 rounded-[3rem] space-y-6">
                            <div><h4 class="font-bold text-white">Integra√ß√£o Webhook</h4><p class="text-xs text-slate-500 mt-2">Receba alertas no Discord ou Slack</p></div>
                            <input type="url" id="webhookUrl" placeholder="https://discord.com/api/webhooks/..." class="input-premium">
                            <button onclick="saveWebhook()" class="w-full bg-indigo-600 py-4 rounded-2xl text-xs font-bold uppercase tracking-widest shadow-lg btn-hover">Salvar URL</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- MODAIS REFORMULADOS -->
    <div id="plan-modal" class="fixed inset-0 z-[160] modal-blur hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-[3rem] max-w-xl w-full p-8 shadow-2xl relative animate-pop-in flex flex-col max-h-[90vh] overflow-hidden">
            <button onclick="closePlanModal()" class="absolute top-8 right-8 text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="flex items-center gap-5 mb-8">
                <div class="bg-pink-600/20 p-4 rounded-3xl"><i data-lucide="package" class="w-8 h-8 text-pink-500"></i></div>
                <div><h2 class="text-2xl font-bold text-white" id="planModalTitle">Configurar Plano</h2><p class="text-xs text-slate-400">Regras de neg√≥cio e pre√ßos</p></div>
            </div>
            <form id="planForm" onsubmit="savePlan(event)" class="space-y-5 overflow-y-auto pr-2 custom-scrollbar">
                <input type="hidden" id="planId">
                <input type="text" id="planName" placeholder="Nome do Plano" required class="input-premium">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="planPrice" placeholder="Valor Mensal (R$)" required class="input-premium">
                    <input type="number" id="planMaxProducts" placeholder="Limite Produtos" required class="input-premium">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="planMaxBanners" placeholder="Limite Banners" required class="input-premium">
                    <select id="planHasCarousel" class="input-premium bg-slate-800"><option value="true">Com Carrossel</option><option value="false">Sem Carrossel</option></select>
                </div>
                <textarea id="planFeatures" class="input-premium min-h-[100px]" placeholder="Benef√≠cios..."></textarea>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closePlanModal()" class="flex-1 py-4 bg-slate-800 text-slate-300 font-bold rounded-2xl">Cancelar</button>
                    <button type="submit" class="flex-2 bg-pink-600 text-white font-bold py-4 px-10 rounded-2xl shadow-lg btn-hover">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-[160] modal-blur hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-[3rem] max-w-lg w-full p-10 shadow-2xl relative animate-pop-in">
            <button onclick="closeEditModal()" class="absolute top-8 right-8 text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="flex items-center gap-5 mb-8">
                <div class="bg-indigo-600/20 p-4 rounded-3xl"><i data-lucide="store" class="w-8 h-8 text-indigo-500"></i></div>
                <div><h2 class="text-2xl font-bold text-white">Editar Loja</h2><p class="text-xs text-slate-400">Manuten√ß√£o de cadastro</p></div>
            </div>
            <form id="editForm" onsubmit="saveStoreEdit(event)" class="space-y-5">
                <input type="hidden" id="editSlug">
                <input type="text" id="editName" placeholder="Nome" required class="input-premium">
                <select id="editPlan" required class="input-premium bg-slate-800"></select>
                <input type="email" id="editEmail" placeholder="E-mail" required class="input-premium">
                <input type="number" id="editBillingDay" placeholder="Dia Vencimento" required class="input-premium">
                <button type="submit" class="w-full py-4.5 bg-indigo-600 text-white font-bold rounded-2xl btn-hover uppercase tracking-widest text-xs">Guardar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAdwsGBTApwOwqr37qCv72gdPRbipsZG0Q", authDomain: "meuestoque-1badc.firebaseapp.com", projectId: "meuestoque-1badc", storageBucket: "meuestoque-1badc.appspot.com", messagingSenderId: "730003067834", appId: "1:730003067834:web:b205f1ea59053345960383" };
        
        const mainApp = initializeApp(firebaseConfig);
        const auth = getAuth(mainApp);
        const db = getFirestore(mainApp);

        let availablePlans = [];
        let allStores = [];
        let config = { audioAlert: true, webhookUrl: '' };
        let lastRequestCount = -1;
        let listenersInitialized = false;

        const formatBRL = (v) => Number(v).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

        // --- AUTH E LOGIN ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnLogin');
            const errorDiv = document.getElementById('loginError');
            btn.disabled = true; 
            btn.innerHTML = '<span class="animate-pulse">Validando Credenciais...</span>';
            errorDiv.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value);
            } catch (err) { 
                errorDiv.innerText = "Email ou senha incorretos.";
                errorDiv.classList.remove('hidden');
                btn.disabled = false; 
                btn.innerHTML = 'ACEDER AO PAINEL';
            }
        });

        onAuthStateChanged(auth, async (user) => {
            const loginScreen = document.getElementById('login-screen');
            const btn = document.getElementById('btnLogin');
            if (user) {
                if(!loginScreen.classList.contains('hidden')) { btn.innerHTML = '<span class="animate-pulse">Verificando...</span>'; btn.disabled = true; }
                try {
                    const adminDoc = await getDoc(doc(db, "internal_admins", user.uid));
                    if (adminDoc.exists()) { 
                        loginScreen.classList.add('hidden'); 
                        btn.disabled = false; btn.innerHTML = 'ACEDER AO PAINEL';
                        if (!listenersInitialized) { setupAllListeners(); listenersInitialized = true; }
                    } else { throw new Error("Acesso negado."); }
                } catch (error) {
                    await signOut(auth);
                    document.getElementById('loginError').innerText = "Acesso restrito.";
                    document.getElementById('loginError').classList.remove('hidden');
                    loginScreen.classList.remove('hidden');
                    btn.disabled = false; btn.innerHTML = 'ACEDER AO PAINEL';
                }
            } else { loginScreen.classList.remove('hidden'); btn.disabled = false; btn.innerHTML = 'ACEDER AO PAINEL'; }
            lucide.createIcons();
        });

        window.handleSignOut = () => signOut(auth).then(() => window.location.reload());

        // --- LISTENERS ---
        function setupAllListeners() {
            onSnapshot(doc(db, "config_superadmin", "notifications"), (d) => {
                if(d.exists()) { config = d.data(); document.getElementById('webhookUrl').value = config.webhookUrl || ''; updateAudioUI(); }
            });

            onSnapshot(collection(db, "config_plans"), (snap) => {
                availablePlans = snap.docs.map(d => ({id: d.id, ...d.data()}));
                const grid = document.getElementById('plansGrid');
                const sSelect = document.getElementById('storePlan');
                const eSelect = document.getElementById('editPlan');
                sSelect.innerHTML = '<option value="">Selecione o plano...</option>';
                eSelect.innerHTML = '';
                grid.innerHTML = availablePlans.map(p => {
                    sSelect.insertAdjacentHTML('beforeend', `<option value="${p.id}">${p.name}</option>`);
                    eSelect.insertAdjacentHTML('beforeend', `<option value="${p.id}">${p.name}</option>`);
                    return `<div class="bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] shadow-lg flex flex-col h-full">
                            <h3 class="font-bold text-white text-xl mb-1">${p.name}</h3>
                            <span class="text-pink-500 text-xs font-black uppercase mb-6">${formatBRL(p.price)}</span>
                            <div class="flex-1 text-[10px] text-slate-400 leading-relaxed">${(p.features||'').split('\n').map(f => `‚Ä¢ ${f}`).join('<br>')}</div>
                            <div class="flex gap-2 pt-6 border-t border-slate-800 mt-6">
                                <button onclick='openPlanModal(${JSON.stringify(p)})' class="flex-1 bg-slate-800 py-3 rounded-2xl text-[10px] font-black uppercase">Editar</button>
                                <button onclick="deletePlan('${p.id}')" class="p-3 text-slate-500 hover:text-red-500 rounded-2xl"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>`;
                }).join('');
                lucide.createIcons();
            });

            onSnapshot(collection(db, "stores_registry"), (snap) => {
                allStores = snap.docs.map(d => d.data());
                renderStoreTable(allStores);
            });

            onSnapshot(collection(db, "registration_requests"), (snap) => {
                const count = snap.size;
                const badge = document.getElementById('reqCountBadge');
                badge.textContent = count;
                badge.classList.toggle('hidden', count === 0);
                document.getElementById('emptyRequests').classList.toggle('hidden', count > 0);
                if(lastRequestCount !== -1 && count > lastRequestCount && config.audioAlert) new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3').play().catch(() => {});
                lastRequestCount = count;
                document.getElementById('requestsList').innerHTML = snap.docs.map(d => {
                    const r = d.data();
                    return `<div class="bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] shadow-xl">
                            <h4 class="text-white font-bold text-xl mb-1">${r.storeName}</h4>
                            <p class="text-slate-400 text-xs mb-4">${r.email}</p>
                            <button onclick='approveRequest(${JSON.stringify({id: d.id, ...r}).replace(/'/g, "&#39;")})' class="w-full bg-indigo-600 py-3.5 rounded-2xl font-black text-[10px] uppercase">Analisar</button>
                        </div>`;
                }).join('');
                lucide.createIcons();
            });
        }

        function renderStoreTable(list) {
            document.getElementById('storesTableBody').innerHTML = list.map(s => `
                <tr class="border-b border-slate-800/50 hover:bg-slate-900/40">
                    <td class="px-8 py-6 font-bold text-white">${s.storeName} <br><span class="text-[9px] text-slate-500 font-mono">${s.slug}</span></td>
                    <td class="px-8 py-6"><span class="bg-indigo-500/10 text-indigo-400 text-[9px] font-black px-2 py-0.5 rounded border border-indigo-500/20 uppercase">${s.planId || 'N/A'}</span></td>
                    <td class="px-8 py-6 text-slate-400 text-xs">${s.ownerEmail}</td>
                    <td class="px-8 py-6 text-[10px] font-bold uppercase ${s.status === 'active' ? 'text-green-400' : 'text-red-400'}">${s.status}</td>
                    <td class="px-8 py-6 text-right flex gap-3 justify-end">
                        <button onclick='openEditModal(${JSON.stringify(s)})' class="p-2.5 text-indigo-400 hover:bg-indigo-900/30 rounded-xl"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="toggleSuspend('${s.slug}', '${s.status}')" class="p-2.5 text-slate-500 hover:text-white rounded-xl"><i data-lucide="power" class="w-4 h-4"></i></button>
                        <button onclick="deleteStore('${s.slug}')" class="p-2.5 text-slate-600 hover:text-red-500 rounded-xl"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`).join('');
            lucide.createIcons();
        }

        // --- A√á√ïES DO SISTEMA ---
        document.getElementById('createStoreForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmitStore');
            btn.disabled = true; btn.innerHTML = 'Ativando...';
            const pId = document.getElementById('storePlan').value;
            const plan = availablePlans.find(p => p.id === pId);
            const slug = document.getElementById('storeSlug').value;
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            const name = document.getElementById('storeName').value;
            const phone = document.getElementById('storePhone').value;
            const rid = document.getElementById('requestId').value;
            const secApp = initializeApp(firebaseConfig, "sec_app_" + Date.now());
            const secAuth = getAuth(secApp);
            try {
                const cred = await createUserWithEmailAndPassword(secAuth, email, pass);
                const storeData = { 
                    storeName: name, ownerEmail: email, ownerPhone: phone, 
                    planId: plan.name, // ALTERA√á√ÉO CIR√öRGICA: Salva o NOME exato do plano
                    maxProducts: plan.maxProducts, maxBanners: plan.maxBanners || 3,
                    hasCarousel: plan.hasCarousel || false, status: 'active', subscriptionStatus: 'active',
                    isStoreOpen: true, billingDay: 10 
                };
                await setDoc(doc(db, "stores", slug, "config", "store"), storeData);
                await setDoc(doc(db, "admin_directory", cred.user.uid), { storeId: slug, role: 'owner' });
                await setDoc(doc(db, "stores_registry", slug), { ...storeData, slug });
                if(rid) await deleteDoc(doc(db, "registration_requests", rid));
                document.getElementById('resEmail').innerText = email; document.getElementById('resPass').innerText = pass;
                document.getElementById('btnWhatsAppNotify').onclick = () => window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${encodeURIComponent(`üöÄ *Sua vitrine est√° ativa!*\nLoja: ${name}\nLogin: ${email}\nSenha: ${pass}`)}`,'_blank');
                await signOut(secAuth); await deleteApp(secApp); switchView('result-view');
            } catch (err) { alert("Erro: " + err.message); await deleteApp(secApp); }
            btn.disabled = false; btn.innerHTML = 'Confirmar e Gerar Acesso';
        });

        window.openPlanModal = (p = null) => {
            document.getElementById('planId').value = p?.id || '';
            document.getElementById('planName').value = p?.name || '';
            document.getElementById('planPrice').value = p?.price || '';
            document.getElementById('planMaxProducts').value = p?.maxProducts || '';
            document.getElementById('planMaxBanners').value = p?.maxBanners || 3;
            document.getElementById('planHasCarousel').value = p?.hasCarousel ? 'true' : 'false';
            document.getElementById('planFeatures').value = p?.features || '';
            document.getElementById('plan-modal').classList.remove('hidden');
        };
        window.closePlanModal = () => document.getElementById('plan-modal').classList.add('hidden');

        window.savePlan = async (e) => {
            e.preventDefault();
            const planNameValue = document.getElementById('planName').value;
            // ALTERA√á√ÉO CIR√öRGICA: O ID interno do plano agora reflete o nome para consist√™ncia
            const id = document.getElementById('planId').value || planNameValue.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '_');
            try {
                await setDoc(doc(db, "config_plans", id), {
                    name: planNameValue,
                    price: parseFloat(document.getElementById('planPrice').value),
                    maxProducts: parseInt(document.getElementById('planMaxProducts').value),
                    maxBanners: parseInt(document.getElementById('planMaxBanners').value),
                    hasCarousel: document.getElementById('planHasCarousel').value === 'true',
                    features: document.getElementById('planFeatures').value
                });
                closePlanModal();
            } catch(e) { alert("Erro ao salvar: " + e.message); }
        };

        window.openEditModal = (s) => {
            document.getElementById('editSlug').value = s.slug;
            document.getElementById('editName').value = s.storeName;
            document.getElementById('editEmail').value = s.ownerEmail;
            // Busca o ID do plano pelo nome para selecionar no select
            const planObj = availablePlans.find(p => p.name === s.planId);
            document.getElementById('editPlan').value = planObj ? planObj.id : '';
            document.getElementById('editBillingDay').value = s.billingDay || 10;
            document.getElementById('edit-modal').classList.remove('hidden');
        };
        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

        window.saveStoreEdit = async (e) => {
            e.preventDefault();
            const slug = document.getElementById('editSlug').value;
            const planSelectedId = document.getElementById('editPlan').value;
            const plan = availablePlans.find(p => p.id === planSelectedId);
            if(!plan) return alert("Selecione um plano v√°lido.");

            // ALTERA√á√ÉO CIR√öRGICA: Agora atualiza todos os campos de limites baseados no plano escolhido
            const data = { 
                storeName: document.getElementById('editName').value, 
                ownerEmail: document.getElementById('editEmail').value, 
                planId: plan.name, // Sincroniza o Nome exato
                maxProducts: plan.maxProducts, 
                maxBanners: plan.maxBanners, // Atualiza limite de banners
                hasCarousel: plan.hasCarousel, // Atualiza suporte a carrossel
                billingDay: parseInt(document.getElementById('editBillingDay').value) 
            };
            try {
                await updateDoc(doc(db, "stores_registry", slug), data);
                await updateDoc(doc(db, "stores", slug, "config", "store"), data);
                alert("Loja atualizada com sucesso!");
                closeEditModal();
            } catch(err) { alert("Erro ao atualizar: " + err.message); }
        };

        window.publishPlansForRegistration = async () => {
            if(!confirm("Publicar para o site?")) return;
            const pubRef = collection(db, "public_plans");
            const snap = await getDocs(pubRef);
            await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
            await Promise.all(availablePlans.map(p => setDoc(doc(pubRef, p.id), {...p, isActive: true, publishedAt: serverTimestamp()})));
            alert("Publicado!");
        };

        window.approveRequest = (r) => {
            document.getElementById('requestId').value = r.id;
            document.getElementById('storeName').value = r.storeName;
            document.getElementById('adminEmail').value = r.email;
            document.getElementById('storeSlug').value = (r.storeName || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '-');
            document.getElementById('adminPass').value = Math.random().toString(36).slice(-8);
            document.getElementById('storePhone').value = r.phone || '';
            const matchedPlan = availablePlans.find(p => p.id === r.planId || p.name === r.planId);
            if(matchedPlan) document.getElementById('storePlan').value = matchedPlan.id;
            switchView('create');
        };

        window.deleteRequest = async (id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, "registration_requests", id)); };
        window.toggleSuspend = async (slug, curr) => {
            const next = curr === 'active' ? 'suspended' : 'active';
            if(!confirm(`Alterar para ${next}?`)) return;
            await updateDoc(doc(db, "stores_registry", slug), { status: next });
            await updateDoc(doc(db, "stores", slug, "config", "store"), { subscriptionStatus: next });
        };
        window.deleteStore = async (s) => { if(confirm("Apagar registro?")) await deleteDoc(doc(db, "stores_registry", s)); };
        window.deletePlan = async (id) => { if(confirm("Apagar plano?")) await deleteDoc(doc(db, "config_plans", id)); };

        // NAVEGA√á√ÉO
        window.switchView = (v) => {
            ['list', 'requests', 'plans', 'create', 'result-view', 'settings'].forEach(x => {
                if(document.getElementById(`view-${x}`)) document.getElementById(`view-${x}`).classList.add('hidden');
                if(document.getElementById(`nav-${x}`)) document.getElementById(`nav-${x}`).classList.remove('bg-indigo-600/10', 'text-indigo-400', 'border-indigo-600/50');
            });
            if(document.getElementById(`view-${v}`)) document.getElementById(`view-${v}`).classList.remove('hidden');
            if(document.getElementById(`nav-${v}`)) document.getElementById(`nav-${v}`).classList.add('bg-indigo-600/10', 'text-indigo-400', 'border-indigo-600/50');
            if(window.innerWidth < 768) toggleSidebar();
        };

        window.toggleAudioAlert = () => { config.audioAlert = !config.audioAlert; saveConfig(); };
        window.saveWebhook = () => { config.webhookUrl = document.getElementById('webhookUrl').value; saveConfig(); };
        async function saveConfig() { await setDoc(doc(db, "config_superadmin", "notifications"), config); updateAudioUI(); }
        function updateAudioUI() {
            const btn = document.getElementById('btnToggleAudio');
            if(!btn) return;
            btn.innerHTML = `<i data-lucide="${config.audioAlert ? 'volume-2' : 'volume-x'}" class="w-5 h-5"></i> <span>Som: ${config.audioAlert ? 'Ativado' : 'Mudo'}</span>`;
            btn.className = `mt-8 py-4 px-6 rounded-2xl border flex items-center justify-center gap-3 font-bold text-xs uppercase ${config.audioAlert ? 'bg-indigo-600/20 text-indigo-400 border-indigo-600/30' : 'bg-slate-800 text-slate-500 border-slate-700'}`;
            lucide.createIcons();
        }
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');
    </script>
</body>
</html>


