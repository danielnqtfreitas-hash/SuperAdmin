<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin | Marketplace Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .input-dark {
            width: 100%;
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: white;
            outline: none;
            transition: all 0.2s;
        }
        .input-dark:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .select-dark {
            width: 100%;
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: white;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 h-screen flex overflow-hidden w-full">

    <!-- MODAL DE PLANOS -->
    <div id="plan-modal" class="fixed inset-0 z-[110] bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 rounded-3xl max-w-lg w-full p-8 shadow-2xl relative animate-fade-in flex flex-col max-h-[90vh] overflow-y-auto">
            <button onclick="closePlanModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="package" class="w-6 h-6 text-pink-500"></i> <span id="planModalTitle">Novo Plano</span></h2>
            <form id="planForm" onsubmit="savePlan(event)" class="space-y-4">
                <input type="hidden" id="planId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Nome do Plano</label>
                        <input type="text" id="planName" placeholder="Ex: Básico, Gold, Black" required class="input-dark">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Preço (R$)</label>
                        <input type="text" id="planPrice" placeholder="0,00" required class="input-dark">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Max. Produtos</label>
                        <input type="number" id="planMaxProducts" required class="input-dark">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Max. Banners</label>
                        <input type="number" id="planMaxBanners" required class="input-dark" value="3">
                    </div>
                    <div class="flex items-end pb-3">
                        <label class="flex items-center cursor-pointer relative">
                            <input type="checkbox" id="planHasCarousel" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            <span class="ml-3 text-sm font-medium text-slate-300">Carrossel Ativo</span>
                        </label>
                    </div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closePlanModal()" class="flex-1 py-3 bg-slate-800 text-slate-300 font-bold rounded-xl">Cancelar</button>
                    <button type="submit" class="flex-1 py-3 bg-pink-600 hover:bg-pink-500 text-white font-bold rounded-xl shadow-lg">Salvar Plano</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 border-r border-slate-800 z-50 transform -translate-x-full md:translate-x-0 md:relative sidebar-transition flex flex-col">
        <div class="h-16 flex items-center justify-between px-6 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-1.5 rounded-lg"><i data-lucide="shield" class="w-5 h-5 text-white"></i></div>
                <span class="font-bold text-lg tracking-tight">Super Admin</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchView('list')" id="nav-list" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all bg-indigo-600/10 text-indigo-400 border border-indigo-600/50">
                <i data-lucide="list" class="w-5 h-5"></i> Lojas Ativas
            </button>
            <button onclick="switchView('requests')" id="nav-requests" class="w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all">
                <div class="flex items-center gap-3"><i data-lucide="user-plus" class="w-5 h-5"></i> Solicitações</div>
                <span id="reqCountBadge" class="hidden bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="switchView('plans')" id="nav-plans" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all">
                <i data-lucide="package" class="w-5 h-5"></i> Gerenciar Planos
            </button>
            <button onclick="switchView('create')" id="nav-create" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all">
                <i data-lucide="plus-circle" class="w-5 h-5"></i> Cadastro Manual
            </button>
        </nav>
    </aside>

    <!-- CONTEÚDO PRINCIPAL -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-950 w-full">
        <header class="h-16 flex items-center px-4 border-b border-slate-800 md:hidden bg-slate-900">
            <button onclick="toggleSidebar()" class="p-2 text-slate-300 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
            <span class="ml-3 font-bold text-lg">Marketplace Admin</span>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 w-full relative">
            <div class="max-w-6xl mx-auto pb-20">
                
                <!-- VIEW: LISTA -->
                <div id="view-list" class="animate-fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white">Lojas Ativas</h2>
                        <div class="relative w-64">
                            <i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-slate-500"></i>
                            <input type="text" id="searchInput" placeholder="Buscar loja..." class="input-dark pl-10 py-2.5">
                        </div>
                    </div>
                    <div class="bg-slate-900 rounded-2xl border border-slate-800 overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-800 text-slate-400 text-xs uppercase font-semibold">
                                <tr>
                                    <th class="p-5">Loja / Plano</th>
                                    <th class="p-5">E-mail</th>
                                    <th class="p-5">Status</th>
                                    <th class="p-5 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="storesTableBody" class="divide-y divide-slate-800">
                                <!-- Lojas carregadas por JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: SOLICITAÇÕES (EDITADA) -->
                <div id="view-requests" class="hidden animate-fade-in">
                    <h2 class="text-2xl font-bold text-white mb-8">Solicitações de Cadastro</h2>
                    <div id="requestsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div id="emptyRequests" class="hidden text-center py-20 text-slate-500 italic">Sem solicitações pendentes.</div>
                </div>

                <!-- VIEW: CRIAR/ATIVAR LOJA -->
                <div id="view-create" class="hidden animate-fade-in">
                    <h2 class="text-2xl font-bold text-white mb-8" id="createTitle">Ativar Nova Loja</h2>
                    <form id="createStoreForm" class="bg-slate-900 p-8 rounded-3xl border border-slate-800 space-y-6">
                        <input type="hidden" id="requestId">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">Nome da Loja</label><input type="text" id="storeName" required class="input-dark"></div>
                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">Slug (URL)</label><input type="text" id="storeSlug" required class="input-dark font-mono text-indigo-300"></div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Plano de Assinatura</label>
                                <select id="storePlan" required class="select-dark">
                                    <option value="">Carregando planos...</option>
                                </select>
                            </div>

                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">Email do Lojista</label><input type="email" id="adminEmail" required class="input-dark"></div>
                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">WhatsApp</label><input type="text" id="storePhone" required class="input-dark"></div>
                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">Senha Provisória</label><input type="text" id="adminPass" required class="input-dark"></div>
                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">Dia Vencimento</label><input type="number" id="billingDay" min="1" max="31" value="10" required class="input-dark"></div>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg">Confirmar Ativação</button>
                    </form>
                </div>

                <!-- VIEW: PLANOS -->
                <div id="view-plans" class="hidden animate-fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-bold text-white">Gerenciar Planos</h2>
                        <button onclick="openPlanModal()" class="bg-pink-600 px-4 py-2 rounded-xl text-sm font-bold shadow-lg">Novo Plano</button>
                    </div>
                    <div id="plansGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                </div>

                <!-- VIEW RESULTADO -->
                <div id="view-result-view" class="hidden animate-fade-in max-w-md mx-auto text-center space-y-6">
                    <div class="bg-green-500/10 border border-green-500/50 rounded-3xl p-8">
                        <i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
                        <h3 class="text-xl font-bold text-white">Loja Ativada com Sucesso!</h3>
                        <p class="text-sm text-slate-400 mt-2">O acesso foi criado. Notifique o lojista pelo WhatsApp.</p>
                        <button id="btnWhatsAppNotify" class="w-full mt-6 bg-[#25D366] text-white font-bold py-4 rounded-xl">Enviar Dados por WhatsApp</button>
                    </div>
                    <button onclick="switchView('list')" class="text-slate-500 text-sm">Voltar para a Lista</button>
                </div>

            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAdwsGBTApwOwqr37qCv72gdPRbipsZG0Q", authDomain: "meuestoque-1badc.firebaseapp.com", projectId: "meuestoque-1badc", storageBucket: "meuestoque-1badc.appspot.com", messagingSenderId: "730003067834", appId: "1:730003067834:web:b205f1ea59053345960383" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let availablePlans = [];
        let isDoingAuth = false;

        onAuthStateChanged(auth, (user) => {
            if (!user && !isDoingAuth) signInAnonymously(auth);
            else if (user) setupListeners();
        });

        function setupListeners() {
            // Monitorar Planos
            onSnapshot(collection(db, "config_plans"), (snapshot) => {
                availablePlans = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                const grid = document.getElementById('plansGrid');
                const storeSelect = document.getElementById('storePlan');
                
                storeSelect.innerHTML = '<option value="">Selecione o Plano...</option>';
                grid.innerHTML = availablePlans.map(p => {
                    storeSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    return `
                        <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl group">
                            <h3 class="font-bold text-white text-lg">${p.name}</h3>
                            <p class="text-pink-500 font-bold mb-4">R$ ${p.price}</p>
                            <ul class="text-xs text-slate-500 space-y-1 mb-6">
                                <li>- Máx ${p.maxProducts} Produtos</li>
                                <li>- ${p.hasCarousel ? 'Com Carrossel' : 'Sem Carrossel'}</li>
                            </ul>
                            <div class="flex gap-2">
                                <button onclick='openPlanModal(${JSON.stringify(p)})' class="flex-1 bg-slate-800 text-xs py-2 rounded-lg font-bold">Editar</button>
                                <button onclick="deletePlan('${p.id}')" class="p-2 text-slate-500 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            });

            // Monitorar Solicitações (EDITADA PARA MOSTRAR PLANO)
            onSnapshot(collection(db, "registration_requests"), (snapshot) => {
                const list = document.getElementById('requestsList');
                const badge = document.getElementById('reqCountBadge');
                badge.textContent = snapshot.size;
                badge.classList.toggle('hidden', snapshot.size === 0);
                
                if(snapshot.empty) {
                    document.getElementById('emptyRequests').classList.remove('hidden');
                    list.innerHTML = '';
                    return;
                }
                
                document.getElementById('emptyRequests').classList.add('hidden');
                list.innerHTML = snapshot.docs.map(d => {
                    const r = d.data();
                    const planName = availablePlans.find(p => p.id === r.planId)?.name || "Não Selecionado";
                    
                    return `
                        <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl">
                            <div class="flex justify-between items-start">
                                <h4 class="text-white font-bold text-lg">${r.storeName}</h4>
                                <span class="bg-indigo-500/10 text-indigo-400 border border-indigo-500/30 px-2 py-0.5 rounded text-[10px] font-bold uppercase">
                                    Plano: ${planName}
                                </span>
                            </div>
                            <p class="text-slate-400 text-xs mt-2"><b>Resp:</b> ${r.ownerName}</p>
                            <p class="text-slate-400 text-xs"><b>E-mail:</b> ${r.email}</p>
                            <div class="flex gap-2 mt-6">
                                <button onclick='approveRequest(${JSON.stringify({id: d.id, ...r})})' class="flex-1 bg-indigo-600 py-2.5 rounded-lg text-xs font-bold">Aprovar e Configurar</button>
                                <button onclick="deleteRequest('${d.id}')" class="p-2.5 border border-slate-700 text-slate-500 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            });

            // Monitorar Lojas Ativas
            onSnapshot(collection(db, "stores_registry"), (snapshot) => {
                const tbody = document.getElementById('storesTableBody');
                tbody.innerHTML = snapshot.docs.map(d => {
                    const s = d.data();
                    return `
                        <tr class="hover:bg-slate-900/50">
                            <td class="p-5 font-bold text-white">${s.storeName}<br><span class="text-[10px] text-slate-500">${s.slug}</span></td>
                            <td class="p-5 text-slate-400 text-xs">${s.ownerEmail}</td>
                            <td class="p-5"><span class="px-2 py-1 rounded text-[10px] font-bold ${s.status === 'active' ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}">${s.status.toUpperCase()}</span></td>
                            <td class="p-5 text-right">
                                <button onclick="deleteStore('${s.slug}')" class="text-slate-500 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
                lucide.createIcons();
            });
        }

        // --- FUNÇÕES DE AÇÃO ---
        window.switchView = (view) => {
            ['list', 'requests', 'create', 'plans', 'result-view'].forEach(v => document.getElementById(`view-${v}`)?.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
        };

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');

        // Aprovar Solicitação: Puxa o planId e seleciona no form
        window.approveRequest = (data) => {
            document.getElementById('requestId').value = data.id;
            document.getElementById('storeName').value = data.storeName;
            document.getElementById('adminEmail').value = data.email;
            document.getElementById('storePhone').value = data.phone;
            document.getElementById('storePlan').value = data.planId || ""; // Seleciona o plano escolhido pelo lojista
            document.getElementById('storeSlug').value = data.storeName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '-');
            document.getElementById('adminPass').value = Math.random().toString(36).slice(-8);
            switchView('create');
        };

        window.deleteRequest = async (id) => { if(confirm("Excluir?")) await deleteDoc(doc(db, "registration_requests", id)); };

        // Cadastro Final
        document.getElementById('createStoreForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const planId = document.getElementById('storePlan').value;
            const plan = availablePlans.find(p => p.id === planId);
            if(!plan) return alert("Selecione um plano.");

            isDoingAuth = true;
            const slug = document.getElementById('storeSlug').value;
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            const phone = document.getElementById('storePhone').value;
            const name = document.getElementById('storeName').value;

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const storeData = {
                    storeName: name,
                    ownerEmail: email,
                    ownerPhone: phone,
                    status: 'active',
                    planId: planId,
                    maxProducts: plan.maxProducts,
                    hasCarousel: plan.hasCarousel,
                    subscriptionStatus: 'active',
                    isStoreOpen: true
                };

                await setDoc(doc(db, "stores", slug, "config", "store"), storeData);
                await setDoc(doc(db, "admin_directory", cred.user.uid), { storeId: slug, role: 'owner', email: email });
                await setDoc(doc(db, "stores_registry", slug), { ...storeData, slug });
                
                const rid = document.getElementById('requestId').value;
                if(rid) await deleteDoc(doc(db, "registration_requests", rid));

                document.getElementById('btnWhatsAppNotify').onclick = () => {
                    const msg = `Sua loja ${name} está ativa! \nPlano: ${plan.name} \nLogin: ${email} \nSenha: ${pass}`;
                    window.open(`https://wa.me/${phone.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');
                };

                await signOut(auth);
                isDoingAuth = false;
                await signInAnonymously(auth);
                switchView('result-view');
            } catch(err) { alert(err.message); isDoingAuth = false; }
        });

        // Gestão de Planos
        window.openPlanModal = (data = null) => {
            const form = document.getElementById('planForm');
            if(data) {
                document.getElementById('planId').value = data.id;
                document.getElementById('planName').value = data.name;
                document.getElementById('planPrice').value = data.price;
                document.getElementById('planMaxProducts').value = data.maxProducts;
                document.getElementById('planMaxBanners').value = data.maxBanners || 3;
                document.getElementById('planHasCarousel').checked = data.hasCarousel;
            } else {
                form.reset();
                document.getElementById('planId').value = "";
            }
            document.getElementById('plan-modal').classList.remove('hidden');
        };

        window.closePlanModal = () => document.getElementById('plan-modal').classList.add('hidden');

        window.savePlan = async (e) => {
            e.preventDefault();
            const id = document.getElementById('planId').value || 'plan_' + Date.now();
            const data = {
                name: document.getElementById('planName').value,
                price: parseFloat(document.getElementById('planPrice').value.replace(',', '.')),
                maxProducts: parseInt(document.getElementById('planMaxProducts').value),
                maxBanners: parseInt(document.getElementById('planMaxBanners').value),
                hasCarousel: document.getElementById('planHasCarousel').checked
            };
            await setDoc(doc(db, "config_plans", id), data);
            closePlanModal();
        };

        window.deletePlan = async (id) => { if(confirm("Apagar plano?")) await deleteDoc(doc(db, "config_plans", id)); };
        window.deleteStore = async (slug) => { if(confirm("Excluir loja definitivamente?")) await deleteDoc(doc(db, "stores_registry", slug)); };

        lucide.createIcons();
    </script>
</body>
</html>

