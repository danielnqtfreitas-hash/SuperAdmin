<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin | Marketplace Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .input-dark {
            width: 100%;
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: white;
            outline: none;
            transition: all 0.2s;
        }
        .input-dark:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .input-dark:disabled { opacity: 0.5; cursor: not-allowed; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 h-screen flex overflow-hidden w-full">

    <!-- EDIT MODAL (Para Lojas Ativas) -->
    <div id="edit-modal" class="fixed inset-0 z-[100] bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 rounded-3xl max-w-lg w-full p-8 shadow-2xl relative animate-fade-in flex flex-col max-h-[90vh] overflow-y-auto">
            <button onclick="closeEditModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="edit-3" class="w-6 h-6 text-indigo-500"></i> Editar Loja</h2>
            <form id="editStoreForm" onsubmit="saveStoreChanges(event)" class="space-y-4">
                <input type="hidden" id="editSlug">
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Nome da Loja</label>
                    <input type="text" id="editStoreName" required class="input-dark">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-2">E-mail do Responsável</label>
                    <input type="email" id="editOwnerEmail" required class="input-dark">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Dia do Vencimento</label>
                    <input type="number" id="editBillingDay" min="1" max="31" required class="input-dark">
                </div>
                <div class="bg-slate-950 p-4 rounded-xl border border-slate-800 mt-4">
                    <h3 class="text-sm font-bold text-white mb-2 flex items-center gap-2"><i data-lucide="key" class="w-4 h-4 text-yellow-500"></i> Segurança</h3>
                    <button type="button" onclick="triggerPasswordReset()" id="btnResetPass" class="w-full bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold py-2.5 rounded-lg border border-slate-700 transition-colors">Enviar Link de Redefinição de Senha</button>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeEditModal()" class="flex-1 py-3 bg-slate-800 text-slate-300 font-bold rounded-xl">Cancelar</button>
                    <button type="submit" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MOBILE OVERLAY -->
    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-40 hidden md:hidden backdrop-blur-sm"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 border-r border-slate-800 z-50 transform -translate-x-full md:translate-x-0 md:relative sidebar-transition flex flex-col">
        <div class="h-16 flex items-center justify-between px-6 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-1.5 rounded-lg"><i data-lucide="shield" class="w-5 h-5 text-white"></i></div>
                <span class="font-bold text-lg tracking-tight">Super Admin</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchView('list')" id="nav-list" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all bg-indigo-600/10 text-indigo-400 border border-indigo-600/50">
                <i data-lucide="list" class="w-5 h-5"></i> Lojas Ativas
            </button>
            <button onclick="switchView('requests')" id="nav-requests" class="w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all">
                <div class="flex items-center gap-3"><i data-lucide="user-plus" class="w-5 h-5"></i> Solicitações</div>
                <span id="reqCountBadge" class="hidden bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="switchView('create')" id="nav-create" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800 transition-all">
                <i data-lucide="plus-circle" class="w-5 h-5"></i> Cadastro Manual
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-900/50 text-indigo-400 flex items-center justify-center text-xs font-bold">SA</div>
                <div><p class="text-xs font-bold text-white">Administrador</p><p class="text-[10px] text-slate-400">Online</p></div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-950 w-full">
        <header class="h-16 flex items-center px-4 border-b border-slate-800 md:hidden bg-slate-900">
            <button onclick="toggleSidebar()" class="p-2 text-slate-300 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
            <span class="ml-3 font-bold text-lg">Marketplace Admin</span>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 w-full relative">
            <div class="max-w-6xl mx-auto pb-20">
                
                <!-- VIEW: LISTA -->
                <div id="view-list" class="animate-fade-in">
                    <h2 class="text-2xl font-bold text-white mb-8">Lojas Ativas</h2>
                    <div class="bg-slate-900 rounded-2xl border border-slate-800 overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800 text-slate-400 text-xs uppercase font-semibold">
                                <tr>
                                    <th class="p-5">Loja</th>
                                    <th class="p-5">Dia Venc.</th>
                                    <th class="p-5">E-mail</th>
                                    <th class="p-5">Status</th>
                                    <th class="p-5 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="storesTableBody" class="divide-y divide-slate-800 text-sm">
                                <tr><td colspan="5" class="p-10 text-center text-slate-500">Carregando lojas...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: SOLICITAÇÕES -->
                <div id="view-requests" class="hidden animate-fade-in">
                    <h2 class="text-2xl font-bold text-white mb-8">Solicitações de Cadastro</h2>
                    <div id="requestsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div id="emptyRequests" class="hidden text-center py-20 text-slate-500">Sem solicitações pendentes.</div>
                </div>

                <!-- VIEW: CRIAR -->
                <div id="view-create" class="hidden animate-fade-in">
                    <h2 class="text-2xl font-bold text-white mb-8" id="createTitle">Cadastrar Nova Loja</h2>
                    <form id="createStoreForm" class="bg-slate-900 p-8 rounded-3xl border border-slate-800 space-y-6">
                        <input type="hidden" id="requestId">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">Nome da Loja</label><input type="text" id="storeName" required class="input-dark"></div>
                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">Slug (ID da URL)</label><input type="text" id="storeSlug" required class="input-dark font-mono text-indigo-300"></div>
                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">Email do Lojista</label><input type="email" id="adminEmail" required class="input-dark"></div>
                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">WhatsApp</label><input type="text" id="storePhone" required class="input-dark" placeholder="5511999999999"></div>
                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">Senha Provisória</label><input type="text" id="adminPass" required class="input-dark"></div>
                            <div><label class="block text-xs font-bold uppercase text-slate-500 mb-2">Dia do Vencimento</label><input type="number" id="billingDay" min="1" max="31" value="10" required class="input-dark"></div>
                        </div>
                        <button type="submit" id="btnSubmit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2">Confirmar e Ativar Loja</button>
                    </form>
                </div>

                <!-- VIEW: RESULTADO -->
                <div id="view-result-view" class="hidden animate-fade-in max-w-md mx-auto">
                    <div class="bg-green-500/10 border border-green-500/50 rounded-3xl p-8 text-center space-y-6">
                        <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto shadow-lg"><i data-lucide="check" class="text-white w-8 h-8"></i></div>
                        <h3 class="text-xl font-bold text-white">Loja Ativada!</h3>
                        <div class="bg-slate-950 p-4 rounded-xl border border-slate-800 text-left text-xs space-y-1">
                            <p><b>E-mail:</b> <span id="resEmail"></span></p>
                            <p><b>Senha:</b> <span id="resPass"></span></p>
                        </div>
                        <button id="btnWhatsAppNotify" class="w-full bg-[#25D366] text-white font-bold py-4 rounded-xl flex justify-center items-center gap-2">Notificar via WhatsApp</button>
                        <button onclick="switchView('list')" class="w-full text-slate-400 text-sm py-2">Voltar à Lista</button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAdwsGBTApwOwqr37qCv72gdPRbipsZG0Q", authDomain: "meuestoque-1badc.firebaseapp.com", projectId: "meuestoque-1badc", storageBucket: "meuestoque-1badc.appspot.com", messagingSenderId: "730003067834", appId: "1:730003067834:web:b205f1ea59053345960383" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isDoingAuth = false;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            onAuthStateChanged(auth, (user) => {
                if (!user && !isDoingAuth) {
                    signInAnonymously(auth);
                } else if (user) {
                    setupListeners();
                }
            });
        });

        function setupListeners() {
            // Lojas Ativas
            onSnapshot(collection(db, "stores_registry"), (snapshot) => {
                const tbody = document.getElementById('storesTableBody');
                tbody.innerHTML = snapshot.docs.map(d => {
                    const s = d.data();
                    const sJson = JSON.stringify(s).replace(/'/g, "&#39;");
                    return `
                        <tr class="border-b border-slate-800 hover:bg-slate-900/50 transition-colors group">
                            <td class="p-5 font-bold text-white">${s.storeName} <br><span class="text-[10px] text-slate-500 font-mono">${s.slug}</span></td>
                            <td class="p-5 text-slate-400">Dia ${s.billingDay}</td>
                            <td class="p-5 text-slate-400">${s.ownerEmail}</td>
                            <td class="p-5"><span class="px-2 py-1 rounded text-[10px] font-bold ${s.status === 'active' ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}">${s.status.toUpperCase()}</span></td>
                            <td class="p-5 text-right flex gap-2 justify-end">
                                <button onclick='openEditModal(${sJson})' class="p-2 text-indigo-400 hover:bg-indigo-900/30 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="toggleSuspend('${s.slug}', '${s.status}')" class="p-2 text-slate-500 hover:text-white"><i data-lucide="power" class="w-4 h-4"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
                lucide.createIcons();
            });

            // Solicitações Pendentes
            onSnapshot(collection(db, "registration_requests"), (snapshot) => {
                const list = document.getElementById('requestsList');
                const badge = document.getElementById('reqCountBadge');
                const empty = document.getElementById('emptyRequests');
                badge.textContent = snapshot.size;
                badge.classList.toggle('hidden', snapshot.size === 0);
                empty.classList.toggle('hidden', snapshot.size > 0);

                list.innerHTML = snapshot.docs.map(d => {
                    const r = d.data();
                    const rJson = JSON.stringify({id: d.id, ...r}).replace(/'/g, "&#39;");
                    return `
                        <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl group hover:border-indigo-500/50 transition-all">
                            <div class="flex justify-between items-start mb-2"><span class="bg-amber-500/10 text-amber-500 border border-amber-500/30 px-2 py-0.5 rounded text-[10px] font-bold">SOLICITAÇÃO</span></div>
                            <h4 class="text-white font-bold text-lg">${r.storeName}</h4>
                            <p class="text-slate-400 text-xs mt-1"><b>Resp:</b> ${r.ownerName}</p>
                            <p class="text-slate-400 text-xs"><b>E-mail:</b> ${r.email}</p>
                            <p class="text-slate-400 text-xs"><b>Fone:</b> ${r.phone}</p>
                            <div class="flex gap-2 mt-6">
                                <button onclick='approveRequest(${rJson})' class="flex-1 bg-indigo-600 text-white text-xs font-bold py-2.5 rounded-lg">Aprovar Cadastro</button>
                                <button onclick="deleteRequest('${d.id}')" class="p-2.5 border border-slate-700 text-slate-500 hover:text-red-400 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            });
        }

        window.switchView = (view) => {
            ['list', 'requests', 'create', 'result-view'].forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if(el) el.classList.add('hidden');
            });
            document.getElementById(`view-${view}`).classList.remove('hidden');

            ['list', 'requests', 'create'].forEach(n => {
                const btn = document.getElementById(`nav-${n}`);
                if(btn) {
                    if(n === view) {
                        btn.classList.add('bg-indigo-600/10', 'text-indigo-400', 'border-indigo-600/50');
                        btn.classList.remove('text-slate-400', 'border-transparent');
                    } else {
                        btn.classList.remove('bg-indigo-600/10', 'text-indigo-400', 'border-indigo-600/50');
                        btn.classList.add('text-slate-400', 'border-transparent');
                    }
                }
            });
            if(window.innerWidth < 768) toggleSidebar();
        };

        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('mobile-overlay').classList.toggle('hidden');
        };

        window.openEditModal = (data) => {
            document.getElementById('editSlug').value = data.slug;
            document.getElementById('editStoreName').value = data.storeName;
            document.getElementById('editOwnerEmail').value = data.ownerEmail;
            document.getElementById('editBillingDay').value = data.billingDay;
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

        window.approveRequest = (data) => {
            document.getElementById('requestId').value = data.id;
            document.getElementById('storeName').value = data.storeName;
            document.getElementById('adminEmail').value = data.email;
            document.getElementById('storePhone').value = data.phone;
            document.getElementById('storeSlug').value = data.storeName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '-');
            document.getElementById('adminPass').value = Math.random().toString(36).slice(-8);
            document.getElementById('createTitle').textContent = "Confirmar Solicitação";
            switchView('create');
        };

        window.deleteRequest = async (id) => {
            if(confirm('Excluir solicitação?')) await deleteDoc(doc(db, "registration_requests", id));
        };

        window.toggleSuspend = async (slug, current) => {
            const newStatus = current === 'active' ? 'suspended' : 'active';
            if(confirm(`Deseja ${newStatus === 'active' ? 'Reativar' : 'Suspender'} a loja?`)) {
                await updateDoc(doc(db, "stores_registry", slug), { status: newStatus });
                await updateDoc(doc(db, "stores", slug, "config", "store"), { subscriptionStatus: newStatus });
            }
        };

        window.saveStoreChanges = async (e) => {
            e.preventDefault();
            const slug = document.getElementById('editSlug').value;
            const data = {
                storeName: document.getElementById('editStoreName').value,
                ownerEmail: document.getElementById('editOwnerEmail').value,
                billingDay: document.getElementById('editBillingDay').value
            };
            await updateDoc(doc(db, "stores_registry", slug), data);
            await updateDoc(doc(db, `stores/${slug}/config/store`), data);
            closeEditModal();
        };

        window.triggerPasswordReset = async () => {
            const email = document.getElementById('editOwnerEmail').value;
            if(confirm(`Enviar link para ${email}?`)) await sendPasswordResetEmail(auth, email);
        };

        document.getElementById('createStoreForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            isDoingAuth = true;
            const rid = document.getElementById('requestId').value;
            const name = document.getElementById('storeName').value;
            const slug = document.getElementById('storeSlug').value;
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            const phone = document.getElementById('storePhone').value;
            const day = document.getElementById('billingDay').value;

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "stores", slug, "config", "store"), { storeName: name, ownerEmail: email, ownerPhone: phone, billingDay: day, subscriptionStatus: 'active', isStoreOpen: true, primaryColor: '#6366f1' });
                await setDoc(doc(db, "admin_directory", cred.user.uid), { storeId: slug, role: 'owner', email: email });
                await setDoc(doc(db, "stores_registry", slug), { storeName: name, slug: slug, ownerEmail: email, status: 'active', billingDay: day });
                if(rid) await deleteDoc(doc(db, "registration_requests", rid));

                document.getElementById('resEmail').textContent = email;
                document.getElementById('resPass').textContent = pass;
                document.getElementById('btnWhatsAppNotify').onclick = () => {
                    const msg = `Sua loja ${name} está ativa! \nLogin: ${email} \nSenha: ${pass}`;
                    window.open(`https://wa.me/${phone.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');
                };
                await signOut(auth);
                isDoingAuth = false;
                await signInAnonymously(auth);
                switchView('result-view');
            } catch(err) { alert(err.message); isDoingAuth = false; }
        });
    </script>
</body>
</html>

